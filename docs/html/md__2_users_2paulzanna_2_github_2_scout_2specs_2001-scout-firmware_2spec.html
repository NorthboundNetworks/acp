<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.15.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ACP - Autonomous Command Protocol: Feature Specification: Custom Firmware for Scout ISR Drone</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ACP - Autonomous Command Protocol<span id="projectnumber">&#160;v0.3.0</span>
   </div>
   <div id="projectbrief">Portable C99 framing library with COBS, CRC16, and HMAC-SHA256 authentication</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.15.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('md__2_users_2paulzanna_2_github_2_scout_2specs_2001-scout-firmware_2spec.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Feature Specification: Custom Firmware for Scout ISR Drone </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md8608"></a></p>
<p><b>Feature Branch</b>: <span class="tt">001-scout-firmware</span> <br  />
 <b>Created</b>: 2025-10-25 <br  />
 <b>Status</b>: Draft <br  />
 <b>Input</b>: User description: "I am building custom firmware for a military-grade drone platform developed for armed forces and first responders. Designed as a rapidly deployable, vehicle-launched Intelligence, Surveillance, and Reconnaissance (ISR) solution, Scout provides tactical overwatch and pre-arrival reconnaissance capabilities in austere or contested environments. Additional information can be found in the README.md file."</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md8609"></a>
Clarifications</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8610"></a>
Session 2025-10-25</h2>
<ul>
<li>Q: What is the CLI security posture and exposure? → A: Local-only CLI over USB/UART; WiFi/AP disabled in flight; no network CLI access.</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8611"></a>
Technical Definitions (for acceptance and measurement)</h2>
<ul>
<li>Telemetry rate and jitter: “≥1 Hz” means at least 1 message per second with acceptable jitter of ±250 ms and end-to-end delivery ≥99% over a continuous 10-minute bench session (see SC-003). Missing up to 1% of intervals over 10 minutes is acceptable provided safety is not impacted.</li>
<li>Loop timing measurement: Loop rate targets must remain within ±5% (SC-004). Measurement uses a rolling 1-second window for instantaneous rate and a p95 loop time computed over the 10-minute bench session. Timing source is ESP-IDF high-resolution timer (<span class="tt">esp_timer</span>) for microsecond timestamps; scheduling is via FreeRTOS tick.</li>
<li>CPU utilization budget: “≤70” refers to total MCU utilization during flight workloads, sampled per 1-second window and summarized over 10 minutes (SC-004). Flight CPU includes RT tasks on the control path and excludes idle/background maintenance.</li>
<li>Link-loss detection: Loss-of-link is declared when no valid command/control or heartbeat is received within 1.0 s (1,000 ms). Disarm must occur within ≤1.0 s from the moment the loss condition is detected (SC-006). Timer source: <span class="tt">esp_timer</span>.</li>
<li>Baseline configuration: Default build profile for board <span class="tt">freenove_esp32_s3_wroom</span> with default loop rates and feature flags as defined in <span class="tt">platformio.ini</span> and <span class="tt">src/CMakeLists.txt</span>; acceptance tests reference this baseline unless stated otherwise.</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md8612"></a>
User Scenarios &amp; Testing <em>(mandatory)</em></h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8613"></a>
User Story 1 - Safe Vehicle-Launch Preflight and Arming (Priority: P1)</h2>
<p>An operator preparing a vehicle-launch can complete a guided preflight, ensure safety gates are satisfied, and arm only when all conditions are met; arming is blocked during configuration mode.</p>
<p><b>Why this priority</b>: Prevents hazardous motor spin-up and aligns with the Constitution’s safety-first principle; essential for field deployment.</p>
<p><b>Independent Test</b>: Execute preflight checklist with device in configuration (WiFi/AP) mode and normal flight mode; verify arming is blocked in config mode and enabled only when all safety gates pass in flight mode.</p>
<p><b>Acceptance Scenarios</b>:</p>
<ol type="1">
<li>Given the device is in WiFi/AP configuration mode, When the operator attempts to arm, Then arming is rejected with a clear message and motors remain stopped.</li>
<li>Given all safety gates are met (sensors OK, receiver OK, CPU budget OK), When the operator arms in flight mode, Then arming is accepted and motors respond to throttle.</li>
<li>Given any safety gate fails during armed state (e.g., receiver loss), When the fault occurs, Then failsafe triggers and the system disarms within the defined response time.</li>
</ol>
<hr  />
<h2 class="doxsection"><a class="anchor" id="autotoc_md8615"></a>
User Story 2 - Command and Telemetry Interoperability (Priority: P1)</h2>
<p>An integration engineer can connect a ground control system, observe basic telemetry, and send basic commands for arming/disarming and mode changes consistent with mission workflow.</p>
<p><b>Why this priority</b>: Enables mission coordination and situational awareness; critical for ISR effectiveness.</p>
<p><b>Independent Test</b>: Connect a standard ground control system, verify periodic heartbeat/status, observe pose and battery data, perform arm/disarm (subject to safety gates), and validate loss-of-link behavior.</p>
<p><b>Acceptance Scenarios</b>:</p>
<ol type="1">
<li>Given a connected control system, When the system is idle, Then telemetry (heartbeat/status) is received periodically (≥1 Hz) with jitter ≤±250 ms and ≥99% delivery over a 10-minute bench interval.</li>
<li>Given safety gates permit arming, When the operator sends an arm command, Then arming succeeds; When disarm command is sent, Then disarm succeeds.</li>
<li>Given command/telemetry link is lost, When loss condition is detected, Then failsafe disarms and the system reports safe state upon reconnection.</li>
</ol>
<hr  />
<h2 class="doxsection"><a class="anchor" id="autotoc_md8617"></a>
User Story 3 - Configuration via CLI with Persistence and Audit (Priority: P2)</h2>
<p>A technician configures parameters through CLI, can export/import full configuration, and confirms changes persist across reboot.</p>
<p><b>Why this priority</b>: Ensures field configurability and maintainability with reproducible setups.</p>
<p><b>Independent Test</b>: Use CLI to <span class="tt">get/set</span> parameters, run <span class="tt">dump</span>, apply <span class="tt">save</span> and reboot, then re-run <span class="tt">dump</span> to confirm changes are persisted; perform round-trip restore.</p>
<p><b>Acceptance Scenarios</b>:</p>
<ol type="1">
<li>Given a default configuration, When a parameter is changed and <span class="tt">save</span> + reboot executed, Then <span class="tt">dump</span> shows the updated value.</li>
<li>Given a saved configuration dump, When it is re-applied and saved, Then the effective configuration matches the dump (round-trip equivalence).</li>
<li>Given invalid parameter input, When applied, Then the system rejects it with a clear error without impacting existing configuration.</li>
</ol>
<hr  />
<h2 class="doxsection"><a class="anchor" id="autotoc_md8619"></a>
User Story 4 - Observability and Performance Budgeting (Priority: P2)</h2>
<p>An operator or engineer can query <span class="tt">status</span> and <span class="tt">stats</span> to confirm loop rates and CPU utilization remain within budget for the baseline configuration.</p>
<p><b>Why this priority</b>: Predictable real-time behavior is essential for stable flight; observability supports safe operations and tuning.</p>
<p><b>Independent Test</b>: Run system at baseline configuration for 10 minutes and record <span class="tt">status</span>/<span class="tt">stats</span>; confirm budgets and loop rate stability.</p>
<p><b>Acceptance Scenarios</b>:</p>
<ol type="1">
<li>Given baseline configuration, When <span class="tt">stats</span> is queried, Then total CPU utilization remains ≤70% and within normal variability.</li>
<li>Given baseline configuration, When <span class="tt">status</span>/<span class="tt">stats</span> is queried, Then reported loop rates remain within ±5% of configured values.</li>
<li>Given optional features are enabled, When CPU budget is exceeded, Then the system provides a clear indication and prevents arming or degrades non-critical features.</li>
</ol>
<hr  />
<h2 class="doxsection"><a class="anchor" id="autotoc_md8621"></a>
Edge Cases</h2>
<ul>
<li>Configuration (WiFi/AP) mode active during vehicle launch attempt</li>
<li>Loss of command/telemetry link before/after arming</li>
<li>Sensor missing or misaligned post-calibration</li>
<li>Excessive CPU load from optional features or payloads</li>
<li>Corrupted or incomplete configuration import</li>
<li>Rapid motion at launch (vehicle acceleration) impacting arming checks</li>
</ul>
<hr  />
<h2 class="doxsection"><a class="anchor" id="autotoc_md8623"></a>
User Story 5 - Sensor Integration, Calibration &amp; Health (Priority: P1)</h2>
<p>The system initializes and validates core sensors (IMU, magnetometer, barometer, GPS), exposes calibration workflows, reports health in <span class="tt">status</span>, and enforces safe behavior (block arming or limit modes) when required sensors are unavailable or unhealthy.</p>
<p><b>Why this priority</b>: Reliable state estimation is foundational for safe flight and mission effectiveness.</p>
<p><b>Independent Test</b>: Power cycle and observe sensor initialization; perform calibration flows where applicable; verify health indicators in <span class="tt">status</span>; confirm arming gates and mode availability respond to sensor health.</p>
<p><b>Acceptance Scenarios</b>:</p>
<ol type="1">
<li>IMU (MPU-6050): Given the system boots and is stationary, When <span class="tt">status</span> is queried, Then IMU reports healthy; When the airframe is moved, Then measured rates/accelerations respond appropriately and health remains OK.</li>
<li>Magnetometer (HMC5883L): Given calibration is initiated and completed, When heading is observed during a slow rotation, Then heading changes smoothly without saturation flags; If magnetometer is unhealthy, Then heading-reliant modes are unavailable.</li>
<li>Barometer (BMP388): Given the system is stationary indoors, When altitude is observed over 10 minutes, Then drift remains within the defined threshold and health remains OK; transient spikes do not cause arming to fail.</li>
<li>GPS (NEO-6M): Given open-sky conditions, When the system starts, Then a 3D fix is obtained within the defined interval and reported in <span class="tt">status</span>; If no fix is available, Then GPS-dependent features are unavailable and the system indicates NO FIX.</li>
</ol>
<h1 class="doxsection"><a class="anchor" id="autotoc_md8624"></a>
Requirements <em>(mandatory)</em></h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8625"></a>
Functional Requirements</h2>
<ul>
<li><b>FR-001</b>: The system MUST block arming while in configuration modes and only permit arming when all safety gates pass.</li>
<li><b>FR-002</b>: The system MUST enter failsafe and disarm upon command/telemetry link loss within the defined response time.</li>
<li><b>FR-003</b>: The CLI MUST provide <span class="tt">version</span>, <span class="tt">status</span>, <span class="tt">stats</span>, <span class="tt">dump</span>, <span class="tt">get</span>, <span class="tt">set</span>, <span class="tt">save</span>, and <span class="tt">reboot</span> commands with stable, human-readable outputs.</li>
<li><b>FR-004</b>: Configuration changes MUST persist across reboot when saved and be fully representable via <span class="tt">dump</span> for export/import.</li>
<li><b>FR-005</b>: <span class="tt">status</span>/<span class="tt">stats</span> outputs MUST include per-loop target and measured rates, p95 loop time over the bench session, and total CPU utilization sufficient to assess performance budgets.</li>
<li><b>FR-006</b>: Telemetry MUST provide periodic heartbeat/status at a minimum of 1 Hz under baseline conditions, with jitter ≤±250 ms and delivery ≥99% over a 10-minute bench test.</li>
<li><b>FR-007</b>: The system MUST accept arm/disarm commands subject to safety gates and report outcomes clearly.</li>
<li><b>FR-008</b>: The system MUST support switching among primary operation modes (e.g., hover, loiter, forward flight) with explicit state indication. Allowed transitions: hover ↔ loiter, loiter → forward (enter), forward → loiter/hover (exit). Mode changes are rejected when safety gates fail; heading-reliant modes remain unavailable if MAG health is not OK.</li>
<li><b>FR-009</b>: Invalid parameter inputs via CLI MUST be rejected with clear errors without mutating current configuration.</li>
<li><b>FR-010</b>: A minimal preflight checklist MUST be documented and executable to verify safety gates prior to arming. Minimal checklist includes: (1) Mode is FLIGHT (not CONFIG), (2) Receiver link OK, (3) IMU/MAG/BARO health OK (GPS optional unless explicitly required), (4) CPU budget OK (≤70%), (5) Vehicle-launch envelope constraints satisfied if applicable.</li>
</ul>
<p>Decisions &amp; Assumptions (Resolved):</p>
<ul>
<li>Primary control authority (MVP): The flight controller is the primary real-time control authority; the companion computer may provide autonomy/vision inputs but MUST NOT bypass flight controller safety gates or timing constraints.</li>
<li>Interoperability profile: The baseline command/telemetry profile uses a standards-compliant heartbeat and basic status/arm/disarm control per a commonly adopted unmanned systems protocol (e.g., a “v2 common” profile). Detailed message mapping will be elaborated in planning.</li>
<li>Vehicle-launch arming envelope: Arming MAY be permitted during vehicle motion up to 80 km/h provided enhanced checks pass (sensor sanity, link quality, CPU budget within limits, and attitude within safe bounds).</li>
<li><b>FR-014</b>: IMU (e.g., MPU-6050 class) MUST initialize at boot, report health in <span class="tt">status</span>, and provide motion readings; arming MUST be blocked if IMU health is not OK.</li>
<li><b>FR-015</b>: Magnetometer (e.g., HMC5883L class) MUST support calibration and health reporting; modes requiring heading MUST be unavailable when magnetometer health is not OK.</li>
<li><b>FR-016</b>: Barometer (e.g., BMP388 class) MUST provide altitude estimates and health reporting; transient pressure anomalies MUST NOT falsely permit arming.</li>
<li><b>FR-017</b>: GPS (e.g., NEO-6M class) MUST report fix state and quality; GPS-dependent features MUST be unavailable when no fix is present; arming MUST NOT depend on GPS unless explicitly configured.</li>
<li><b>FR-018</b>: The system MUST provide a user-accessible calibration workflow (via CLI) for applicable sensors with clear prompts and outcomes. See <span class="tt">contracts/calibration-workflows.md</span> for steps, acceptance, and operator feedback.</li>
<li><b>FR-019</b>: Sensor health summaries MUST be included in <span class="tt">status</span>, and faults MUST be reflected in preflight checklist results.</li>
<li><b>FR-020</b>: If a sensor fails in flight, the system MUST degrade behavior safely (e.g., restrict modes, increase stability margins, or disarm if safety is compromised) and record the fault in health reporting. See <span class="tt">contracts/degrade-policy.md</span> for per-fault actions and operator feedback.</li>
</ul>
<p>Assumptions:</p>
<ul>
<li>The baseline configuration refers to the default project setup as documented in README and docs.</li>
<li>Ground control systems use commonly adopted control and telemetry conventions relevant to ISR operations.</li>
</ul>
<p>Additional Functional Requirements (from decisions):</p>
<ul>
<li><b>FR-011</b>: The flight controller MUST remain the primary real-time control authority; companion inputs MUST be mediated and subject to all safety gates.</li>
<li><b>FR-012</b>: The system MUST expose a baseline, standards-compliant SCP v1.1 profile for status and arm/disarm control suitable for mission system integration. Message mapping and rates are defined in the SCP contracts and must be kept in sync with implementation.</li>
<li><b>FR-013</b>: Arming during vehicle motion is permitted only when vehicle speed ≤ 80 km/h, attitude is within safe bounds (e.g., roll/pitch within ±15°), receiver link quality is above the defined threshold, sensors report OK, and CPU budget is within limits.</li>
<li><b>FR-021</b>: The CLI MUST be accessible only over local USB/UART; network exposure of the CLI is prohibited. WiFi/AP MUST be disabled during flight mode and MUST NOT provide CLI access at any time.</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8626"></a>
Key Entities <em>(include if feature involves data)</em></h2>
<ul>
<li><b>Configuration Profile</b>: Collection of parameters, version metadata, checksum; exportable via <span class="tt">dump</span>.</li>
<li><b>Safety State</b>: Aggregated readiness gates (sensors, link, CPU budget, mode) and arming state.</li>
<li><b>Flight Mode</b>: Current operation mode (e.g., hover, loiter, forward), with constraints and transitions.</li>
<li><b>Telemetry Packet</b>: Periodic status including system health, pose, battery, and state indicators.</li>
<li><b>Preflight Checklist</b>: Ordered steps and pass/fail outcomes recorded for arming readiness.</li>
<li><b>Sensor Health Report</b>: Aggregated per-sensor health states (IMU, magnetometer, barometer, GPS), calibration status, and last-fault indicators.</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md8627"></a>
Success Criteria <em>(mandatory)</em></h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8628"></a>
Measurable Outcomes</h2>
<ul>
<li><b>SC-001</b>: During preflight, arming attempts in configuration mode are rejected 100% of the time with clear operator feedback.</li>
<li><b>SC-002</b>: Operators can complete preflight and be mission-ready within 2 minutes under standard conditions.</li>
<li><b>SC-003</b>: Telemetry provides periodic status at ≥1 Hz with jitter ≤±250 ms and ≥99% delivery over a continuous 10-minute bench test.</li>
<li><b>SC-004</b>: Under baseline conditions, reported total CPU utilization remains ≤70% and loop rates remain within ±5% of configured values for at least 10 minutes.</li>
<li><b>SC-005</b>: Configuration parameter changes persist across reboot and pass a round-trip export/import equivalence test (no drift in effective configuration).</li>
<li><b>SC-006</b>: On loss of command/telemetry link, disarm occurs within ≤1 second of detecting loss (no valid control/heartbeat for 1.0 s) and the system reports safe state upon reconnection.</li>
<li><b>SC-007</b>: During vehicle-launch tests within the defined envelope (≤80 km/h), arming is permitted only when enhanced checks pass and is always rejected when any check fails; above the envelope, arming is always rejected.</li>
<li><b>SC-008</b>: A baseline interoperability test demonstrates periodic heartbeat/status and arm/disarm control using the agreed profile over a continuous 10-minute bench session without dropouts impacting control safety.</li>
<li><b>SC-009</b>: With the airframe stationary for 5 minutes, IMU health remains OK and motion estimates remain within expected noise bounds; with deliberate movement, readings reflect motion without triggering health faults.</li>
<li><b>SC-010</b>: After calibration, magnetometer heading changes smoothly during a slow 360° rotation without saturation flags; heading-reliant modes remain unavailable if magnetometer health is not OK.</li>
<li><b>SC-011</b>: In a 10-minute indoor bench test, barometric altitude drift remains within a small threshold (e.g., ≤1 m) and does not cause arming to fail when other safety gates pass.</li>
<li><b>SC-012</b>: Under open-sky conditions, a 3D GPS fix is achieved within a typical interval (e.g., ≤90 seconds) and is reflected in <span class="tt">status</span>; when no fix is present, GPS-dependent features remain unavailable and the system clearly indicates NO FIX.</li>
<li><b>SC-013</b>: In flight mode, WiFi/AP is disabled and any attempt to access the CLI over network interfaces fails; only local USB/UART access is accepted. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on <span class="timestamp"></span> for ACP - Autonomous Command Protocol by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.15.0 </li>
  </ul>
</div>
</body>
</html>
