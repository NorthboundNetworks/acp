<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.15.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ACP - Autonomous Command Protocol: Secure Control Protocol (SCP) v1.1 — Specification (Hardened)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ACP - Autonomous Command Protocol<span id="projectnumber">&#160;v0.3.0</span>
   </div>
   <div id="projectbrief">Portable C99 framing library with COBS, CRC16, and HMAC-SHA256 authentication</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.15.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('md__2_users_2paulzanna_2_github_2_scout_2docs_2scp__comm__spec__v1-1.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Secure Control Protocol (SCP) v1.1 — Specification (Hardened) </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md8260"></a></p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md8261"></a>
Purpose</h1>
<p>Define a secure, auditable, and robust binary protocol for communication between the Scout drone firmware and the Citadel ground control system (GCS) or onboard companion. SCP v1.1 incorporates hardened framing, authentication, and observability updates in preparation for contested field environments and military evaluation.</p>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md8263"></a>
Goals</h1>
<ul>
<li>Enable full mission control and telemetry using a compact, tamper-resistant binary format</li>
<li>Mediate all incoming commands through the existing safety and audit infrastructure</li>
<li>Support operation over UART, USB CDC, or SPI</li>
<li>Add support for message authentication, replay protection, and improved framing</li>
<li>Prepare for STANAG 4586 compatibility at the GCS layer</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md8265"></a>
Protocol Frame Structure (v1.1)</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Field  </th><th class="markdownTableHeadNone">Size (bytes)  </th><th class="markdownTableHeadNone">Description  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">SYNC  </td><td class="markdownTableBodyNone">2  </td><td class="markdownTableBodyNone">Start marker: <span class="tt">0xAA 0x55</span>  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Version  </td><td class="markdownTableBodyNone">1  </td><td class="markdownTableBodyNone">Protocol version (e.g. <span class="tt">0x01</span>)  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">MsgType  </td><td class="markdownTableBodyNone">1  </td><td class="markdownTableBodyNone">Message identifier  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">SeqNum  </td><td class="markdownTableBodyNone">1  </td><td class="markdownTableBodyNone">Per-session sequence number  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Flags  </td><td class="markdownTableBodyNone">1  </td><td class="markdownTableBodyNone">Bitfield: <span class="tt">0x01</span> = auth present, <span class="tt">0x02</span> = compressed  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Length  </td><td class="markdownTableBodyNone">2  </td><td class="markdownTableBodyNone">Payload size (including <span class="tt">auth_tag</span> if present)  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Payload  </td><td class="markdownTableBodyNone">N  </td><td class="markdownTableBodyNone">Message body (structured, COBS-encoded)  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">AuthTag  </td><td class="markdownTableBodyNone">16 (opt.)  </td><td class="markdownTableBodyNone">HMAC-SHA256 tag (if auth flag set)  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">CRC16  </td><td class="markdownTableBodyNone">2  </td><td class="markdownTableBodyNone">CRC-16-CCITT (header + payload + auth)  </td></tr>
</table>
<ul>
<li><b>Framing</b>: COBS (Consistent Overhead Byte Stuffing) encoding</li>
<li><b>Authentication</b>: Optional per-message HMAC-SHA256 (truncated to 16 bytes)</li>
<li><b>Replay Protection</b>: Session nonce + SeqNum enforcement</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md8267"></a>
Message Types</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8268"></a>
GCS → Drone Commands</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">MsgType  </th><th class="markdownTableHeadNone">Name  </th><th class="markdownTableHeadNone">Description  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x01  </td><td class="markdownTableBodyNone"><span class="tt">cmd_control</span>  </td><td class="markdownTableBodyNone">Arm, disarm, mode set  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x02  </td><td class="markdownTableBodyNone"><span class="tt">cmd_gimbal</span>  </td><td class="markdownTableBodyNone">Gimbal movement commands  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x03  </td><td class="markdownTableBodyNone"><span class="tt">cmd_config</span>  </td><td class="markdownTableBodyNone">Field or system config update  </td></tr>
</table>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8269"></a>
Drone → GCS Telemetry / Events</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">MsgType  </th><th class="markdownTableHeadNone">Name  </th><th class="markdownTableHeadNone">Description  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x10  </td><td class="markdownTableBodyNone"><span class="tt">tlm_status</span>  </td><td class="markdownTableBodyNone">Basic telemetry (state, GPS)  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x11  </td><td class="markdownTableBodyNone"><span class="tt">tlm_gimbal</span>  </td><td class="markdownTableBodyNone">Gimbal angle/status feedback  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x12  </td><td class="markdownTableBodyNone"><span class="tt">tlm_audit</span>  </td><td class="markdownTableBodyNone">Command audit log event  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x13  </td><td class="markdownTableBodyNone"><span class="tt">tlm_mission</span>  </td><td class="markdownTableBodyNone">Summary of mission log  </td></tr>
</table>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8270"></a>
Responses</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">MsgType  </th><th class="markdownTableHeadNone">Name  </th><th class="markdownTableHeadNone">Description  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x20  </td><td class="markdownTableBodyNone"><span class="tt">ack_response</span>  </td><td class="markdownTableBodyNone">Acknowledgement w/ session ID  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x21  </td><td class="markdownTableBodyNone"><span class="tt">err_response</span>  </td><td class="markdownTableBodyNone">Rejection reason / error code  </td></tr>
</table>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md8272"></a>
Example Structs (Packed C Representations)</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8273"></a>
<span class="tt">cmd_control_t</span></h2>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code hl_struct" href="struct____attribute____.html">__attribute__</a>((packed)) {</div>
<div class="line">  uint8_t arm;         <span class="comment">// 0 = disarm, 1 = arm</span></div>
<div class="line">  uint8_t mode;        <span class="comment">// 0 = hover, 1 = loiter, 2 = forward</span></div>
<div class="line">  uint32_t session_id; <span class="comment">// GCS session identifier</span></div>
<div class="line">} cmd_control_t;</div>
<div class="ttc" id="astruct____attribute_____html"><div class="ttname"><a href="struct____attribute____.html">__attribute__</a></div><div class="ttdef"><b>Definition</b> <a href="scp_8h_source.html#l00045">scp.h:46</a></div></div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md8274"></a>
<span class="tt">tlm_status_t</span></h2>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code hl_struct" href="struct____attribute____.html">__attribute__</a>((packed)) {</div>
<div class="line">  uint8_t armed;</div>
<div class="line">  uint8_t mode;</div>
<div class="line">  uint8_t gps_fix;</div>
<div class="line">  uint8_t battery_percent;</div>
<div class="line">  int16_t roll, pitch, yaw;     <span class="comment">// in degrees × 100</span></div>
<div class="line">  int32_t lat, lon, alt;        <span class="comment">// in cm</span></div>
<div class="line">  uint32_t uptime_ms;</div>
<div class="line">  uint32_t timestamp_ms;</div>
<div class="line">  uint8_t seq_num;</div>
<div class="line">} tlm_status_t;</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md8275"></a>
<span class="tt">tlm_audit_t</span></h2>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code hl_struct" href="struct____attribute____.html">__attribute__</a>((packed)) {</div>
<div class="line">  uint8_t source;     <span class="comment">// 0 = GCS, 1 = Companion</span></div>
<div class="line">  uint8_t action;     <span class="comment">// e.g., CMD_MODE_CHANGE</span></div>
<div class="line">  uint8_t result;     <span class="comment">// 0 = reject, 1 = accept</span></div>
<div class="line">  uint32_t session_id;</div>
<div class="line">  uint32_t timestamp_ms;</div>
<div class="line">} tlm_audit_t;</div>
</div><!-- fragment --><hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md8277"></a>
Safety &amp; Mediation Requirements</h1>
<ul>
<li>All GCS commands must pass through the same <b>audit + safety gates</b> as companion inputs</li>
<li>Audit logs must capture:<ul>
<li>Command source (GCS/Companion)</li>
<li>Result (accepted/rejected)</li>
<li>Reason (if rejected)</li>
<li>Session ID and timestamp</li>
</ul>
</li>
<li>Unsupported MsgTypes must return <span class="tt">err_response</span> with expanded error codes</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8278"></a>
Error Codes</h2>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> {</div>
<div class="line">  ERR_OK = 0x00,</div>
<div class="line">  ERR_UNKNOWN = 0x01,</div>
<div class="line">  ERR_CRC_FAIL = 0x02,</div>
<div class="line">  ERR_SAFETY_REJECT = 0x03,</div>
<div class="line">  ERR_AUTH_FAIL = 0x04,</div>
<div class="line">  ERR_RESOURCE = 0x05,</div>
<div class="line">  ERR_REPLAY = 0x06</div>
<div class="line">} scp_err_t;</div>
</div><!-- fragment --><hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md8280"></a>
Extensibility &amp; Future Features</h1>
<ul>
<li>Session management (auto-expiry after 15 min inactivity)</li>
<li>Dynamic telemetry rate configuration via <span class="tt">cmd_config</span></li>
<li>Compression support for telemetry (bit-packed)</li>
<li>STANAG 4586 mapping table in GCS layer</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md8282"></a>
Implementation Notes</h1>
<ul>
<li>All decoding, dispatch, and CRC logic will reside in <span class="tt"><a class="el" href="gcs__gateway_8c.html" title="GCS Gateway Service Implementation.">src/services/gcs_gateway.c</a></span></li>
<li>COBS decoding and framing logic in <span class="tt">src/utils/scp_framer.c</span></li>
<li>Authentication handled by <span class="tt">src/utils/scp_crypto.c</span> (HMAC-SHA256)</li>
<li>Unit tests must verify:<ul>
<li>Round-trip encode/decode</li>
<li>CRC mismatch rejection</li>
<li>Replay rejection</li>
<li>Auth tag verification</li>
<li>Audit trail correctness</li>
</ul>
</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md8284"></a>
Success Criteria</h1>
<ul>
<li>✅ Commands accepted only after safety checks and HMAC validation</li>
<li>✅ Commands rejected produce <span class="tt">err_response</span> and <span class="tt">tlm_audit</span> entry</li>
<li>✅ <span class="tt">tlm_status</span> transmitted at configured rate (1–10 Hz) with stable timing</li>
<li>✅ Replay attempts rejected (sequence/nonce mismatch)</li>
<li>✅ CRC failures drop packets with error log</li>
<li>✅ Protocol backward-compatible with v1.0 (header interpreted safely)</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md8286"></a>
Out of Scope</h1>
<ul>
<li>SCP is the sole production protocol</li>
<li>No direct Lattice OS integration</li>
<li>No in-flight OTA configuration changes </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on <span class="timestamp"></span> for ACP - Autonomous Command Protocol by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.15.0 </li>
  </ul>
</div>
</body>
</html>
