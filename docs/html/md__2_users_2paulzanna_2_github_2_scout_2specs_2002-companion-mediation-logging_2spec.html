<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.15.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ACP - Autonomous Command Protocol: Feature Specification: Companion Mediation, Blackbox Logging, and Gimbal Control</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ACP - Autonomous Command Protocol<span id="projectnumber">&#160;v0.3.0</span>
   </div>
   <div id="projectbrief">Portable C99 framing library with COBS, CRC16, and HMAC-SHA256 authentication</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.15.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('md__2_users_2paulzanna_2_github_2_scout_2specs_2002-companion-mediation-logging_2spec.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Feature Specification: Companion Mediation, Blackbox Logging, and Gimbal Control </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md8692"></a></p>
<p><b>Feature Branch</b>: <span class="tt">002-companion-mediation-logging</span> <br  />
 <b>Created</b>: 2025-10-26 <br  />
 <b>Status</b>: Draft <br  />
 <b>Input</b>: User description: "Define next feature set: 1) Companion input mediation and logging (safety-gated, auditable), 2) Field blackbox logging and mission replay, 3) Basic gimbal &amp; camera coordination with operator interfaces. Target platform unchanged from 001-scout-firmware."</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md8693"></a>
Clarifications</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8694"></a>
Session 2025-10-26</h2>
<ul>
<li>Q: What is the telemetry audit summary rate limit? → A: 2 msgs/sec max, coalesce within 500 ms.</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md8695"></a>
User Scenarios &amp; Testing <em>(mandatory)</em></h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8696"></a>
User Story 1 - Companion Commands Are Always Safety-Gated (Priority: P1)</h2>
<p>As an operator, I want all companion-computer inputs (navigation hints, mission goals, autonomy directives) to be mediated by the flight controller’s safety gates so that unsafe or out-of-policy commands are blocked and auditable.</p>
<p><b>Why this priority</b>: Prevents accidental or malicious bypass of safety, ensures operator trust, and provides accountability with an audit trail.</p>
<p><b>Independent Test</b>: Can be fully tested by injecting companion inputs under different modes/constraints and verifying: a) aircraft only executes allowed commands, b) every input is logged with decision and reason, c) operator can view audit summaries.</p>
<p><b>Acceptance Scenarios</b>:</p>
<ol type="1">
<li>Given the aircraft is disarmed, When the companion sends a takeoff command, Then the command is rejected, logged with decision="rejected" and reason="disarmed", and an operator-visible audit entry is available.</li>
<li>Given a geofence and max-altitude are configured, When the companion sends a waypoint outside geofence or above max-altitude, Then the command is rejected, logged with the violated policy, and a brief operator message is available.</li>
<li>Given position-hold mode is active, When the companion sends a small heading change suggestion, Then the suggestion is evaluated, allowed if within attitude/slew limits, executed, and the log records classification="suggestion", decision="allowed".</li>
<li>Given link loss failsafe is active, When the companion continues sending commands, Then all commands are rejected until failsafe clears, and the log shows continuous rejections with reason="failsafe" without flooding (rate-limited).</li>
</ol>
<hr  />
<h2 class="doxsection"><a class="anchor" id="autotoc_md8698"></a>
User Story 2 - Field Blackbox Logging &amp; Post-Flight Mission Replay (Priority: P2)</h2>
<p>As a field team, I want critical events, sensor summaries, and all operator/companion commands recorded to an onboard mission log and replayable/exportable after landing so I can review mission flow and investigate issues.</p>
<p><b>Why this priority</b>: Enables rapid debrief, diagnostics, and evidence for training and compliance without external tooling.</p>
<p><b>Independent Test</b>: Can be fully tested by flying a short mission (or bench simulation), then using CLI/telemetry to list, replay, and export the log; verify the timeline, key events, and storage policies.</p>
<p><b>Acceptance Scenarios</b>:</p>
<ol type="1">
<li>Given a completed flight, When the operator runs a "list missions" command, Then the last mission appears with timestamp, duration, and size.</li>
<li>Given the mission is selected, When "replay summary" is invoked, Then the system outputs a chronological sequence of high-level events (arm/disarm, mode changes, safety violations, companion/operator commands, gimbal mode changes) with timestamps.</li>
<li>Given storage is near capacity, When a new mission starts, Then the oldest missions are purged according to rotation policy and a purge event is added to the system log.</li>
<li>Given an export is requested, When output is directed to a connected interface, Then the mission is exported in a portable, structured format suitable for external analysis.</li>
</ol>
<hr  />
<h2 class="doxsection"><a class="anchor" id="autotoc_md8700"></a>
User Story 3 - Basic Gimbal &amp; Camera Coordination (Priority: P3)</h2>
<p>As an operator, I want to set basic gimbal modes (fixed, follow heading, search sweep) and see current angle/mode/faults via CLI or telemetry so that the camera aligns with the mission need.</p>
<p><b>Why this priority</b>: Improves target observation and operator situational awareness with minimal complexity.</p>
<p><b>Independent Test</b>: Can be fully tested by switching modes on bench, verifying angles change as expected, sweep respects limits, and status feedback updates correctly.</p>
<p><b>Acceptance Scenarios</b>:</p>
<ol type="1">
<li>Given gimbal mode is "fixed", When the operator sets pitch=-10° and yaw=30°, Then the gimbal holds those angles within tolerance and reports angles and mode.</li>
<li>Given gimbal mode is "follow heading", When the aircraft heading changes by 45°, Then the gimbal yaw tracks the change within defined slew limits and reports updated angles.</li>
<li>Given gimbal mode is "search sweep", When configured with bounds and rate, Then the gimbal sweeps between min/max yaw continuously and exposes mode and any faults if limits are hit.</li>
</ol>
<hr  />
<p>[Add more user stories as needed, each with an assigned priority]</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8702"></a>
Edge Cases</h2>
<ul>
<li>Companion sends high-rate or duplicate commands: system applies debouncing/rate limits to prevent log/CPU flooding while preserving audit.</li>
<li>Commands arrive during hard failsafe (e.g., link loss, critical battery): all rejected with consistent reason codes; no safety bypass.</li>
<li>Geofence/altitude boundaries exactly at threshold: inclusive/exclusive comparisons are defined and consistent across evaluation and logging.</li>
<li>Onboard log storage full mid-flight: system enforces rotation policy without blocking flight-critical tasks; logs remain consistent (no partial writes visible as valid records).</li>
<li>Time source drift (companion vs controller): logs use a single authoritative flight-controller timebase; companion-provided timestamps are recorded as metadata if present.</li>
<li>Gimbal physical limits reached or driver fault: commands saturate at safe limits; faults are reported in status; sweep pauses or re-centers per policy.</li>
<li>Replay of corrupted/partial logs: system detects integrity issues and reports which segments are readable; no crash or hang.</li>
<li>Operator disconnects during export: export aborts gracefully and can be retried; no mission data loss.</li>
<li>Export verification failure (bad or missing HMAC): system reports integrity/authenticity failure; replay/export tools refuse to trust the file and provide guidance to re-export.</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md8703"></a>
Requirements <em>(mandatory)</em></h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8704"></a>
Functional Requirements</h2>
<ul>
<li>Companion Input Mediation &amp; Audit<ul>
<li><b>FR-001</b>: The system MUST evaluate every companion-provided input through flight safety gates (arming state, mode permissions, geofence, altitude/speed limits, failsafe status, parameter lockouts) before any effect on actuators or navigation.</li>
<li><b>FR-002</b>: The system MUST never allow companion inputs to bypass configured safety, mode, or configuration restrictions.</li>
<li><b>FR-003</b>: The system MUST classify each companion input as "command" or "suggestion" and include this classification in the audit log and decision process.</li>
<li><b>FR-004</b>: The system MUST log for each companion input: timestamp, source, classification, parsed summary, decision (allowed/rejected), and reason codes for rejections.</li>
<li><b>FR-005</b>: The system MUST provide operator-visible audit mechanisms to query recent companion inputs and their decisions via onboard CLI and via a telemetry-accessible summary view.</li>
<li><b>FR-006</b>: The system MUST prevent log flooding by applying per-source rate limits and batching summaries while retaining at least one entry per unique decision reason within any 1-second window.</li>
<li><b>FR-007</b>: The system MUST ensure audit visibility for rejected inputs by presenting a concise operator-facing message within 1 second of rejection.</li>
<li><b>FR-008</b>: Only a single whitelisted companion identity is authorized to provide inputs; all other sources MUST be rejected at the input gateway and logged with reason "unauthorized source".</li>
</ul>
</li>
<li>Field Blackbox Logging &amp; Replay<ul>
<li><b>FR-010</b>: The system MUST record per-flight mission logs containing: session metadata (start/stop time, duration), critical events (arm/disarm, mode changes, failsafe events), periodic sensor summaries, operator commands, companion inputs and their decisions, and gimbal mode/angle changes.</li>
<li><b>FR-011</b>: The system MUST store mission logs in onboard non-volatile storage with a rotation policy that retains only the most recent complete mission (keep last 1 mission); older missions are purged automatically when a new mission starts or when storage constraints require it.</li>
<li><b>FR-012</b>: The system MUST provide an interface to list available mission logs with timestamps, durations, and approximate sizes.</li>
<li><b>FR-013</b>: The system MUST provide a replay interface that outputs an ordered, human-readable timeline of recorded events with timestamps and concise details.</li>
<li><b>FR-014</b>: The system MUST provide an export mechanism to stream or transfer a mission log in a portable, structured format suitable for external analysis tools.</li>
<li><b>FR-015</b>: The system MUST detect and report corrupted or partial logs during listing, replay, and export without crashing.</li>
<li><b>FR-016</b>: Mission log export format SHALL be JSON Lines (NDJSON): one UTF-8 JSON object per line representing a single BlackboxEvent; each record includes at least timestamp, type, and payload summary fields and a schema version for forward compatibility.</li>
<li><b>FR-018</b>: Mission log exports SHALL include an HMAC-SHA256 over the NDJSON content using a shared key managed via operator configuration; export metadata MUST include algorithm identifier, key label, and signature. Verification failure MUST be reported and export consumers MUST treat the file as untrusted.</li>
<li><b>FR-017</b>: Periodic sensor summaries SHALL be recorded every 2 seconds by default.</li>
</ul>
</li>
<li>Gimbal &amp; Camera (Basic)<ul>
<li><b>FR-020</b>: The system MUST support gimbal modes: fixed, follow-heading, and search-sweep.</li>
<li><b>FR-021</b>: In fixed mode, the operator MUST be able to set target pitch and yaw angles, held within a defined tolerance (see Success Criteria).</li>
<li><b>FR-022</b>: In follow-heading mode, the gimbal yaw MUST track aircraft heading changes within defined slew limits while maintaining commanded pitch.</li>
<li><b>FR-023</b>: In search-sweep mode, the gimbal MUST sweep yaw between configurable min/max bounds at a configurable rate; defaults: yaw range ±135° and sweep rate 10°/s.</li>
<li><b>FR-024</b>: The system MUST expose gimbal controls and status via onboard CLI and via a standard telemetry control path compatible with common ground-control tools.</li>
<li><b>FR-025</b>: The system MUST report gimbal status (current angles, mode, and any fault/limit state) on demand and upon significant changes.</li>
</ul>
</li>
<li>Operator Visibility &amp; Telemetry<ul>
<li><b>FR-030</b>: The system MUST provide a concise, rate-limited telemetry summary including safety rejections and arming/mode changes (standard verbosity); other events (e.g., allowed companion actions) are excluded from the real-time summary.</li>
<li><b>FR-031</b>: The system MUST provide CLI commands to: a) show recent companion input decisions, b) list missions, c) replay a mission summary, d) export a mission log, e) control gimbal modes and set angles.</li>
</ul>
</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8705"></a>
Key Entities <em>(include if feature involves data)</em></h2>
<ul>
<li><b>CompanionInput</b>: A mediated input from the companion. Attributes: timestamp, source identity, classification (command/suggestion), payload summary, correlation id, decision, reason codes.</li>
<li><b>SafetyEvaluation</b>: The evaluation result for an input. Attributes: gates evaluated, pass/fail per gate, final decision, reason codes.</li>
<li><b>BlackboxEvent</b>: A recorded event in the mission log. Attributes: timestamp, type (mode change, failsafe, sensor summary, operator cmd, companion input, gimbal update), payload summary, severity.</li>
<li><b>MissionLog</b>: A per-flight record. Attributes: mission id, start/end time, duration, size, integrity status, list of BlackboxEvents, storage index.</li>
<li><b>GimbalState</b>: Current gimbal status. Attributes: mode, target angles, actual angles, slew limits, bounds (for sweep), fault/limit flags, last update time.</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8706"></a>
Assumptions</h2>
<ul>
<li>Mission replay is post-flight (after landing); limited on-vehicle replay during flight is for brief summaries only to avoid distraction.</li>
<li>The flight controller provides the authoritative timebase for logging; companion-provided timestamps may be captured as metadata but not used for ordering.</li>
<li>Onboard non-volatile storage is available with sufficient budget to retain multiple recent missions; rotation can purge oldest complete missions first.</li>
<li>Operator interfaces include the existing onboard command-line interface and a standard telemetry channel compatible with common ground-control tools; no custom external app is required.</li>
<li>Gimbal hardware supports basic pitch and yaw control and reports its current state; advanced stabilization is out-of-scope for this feature.</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md8707"></a>
Success Criteria <em>(mandatory)</em></h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8708"></a>
Measurable Outcomes</h2>
<ul>
<li><b>SC-001</b>: 100% of companion inputs observed during testing are evaluated by safety gates and produce an audit record with decision and reason code; zero instances of unmediated effect on vehicle behavior.</li>
<li><b>SC-002</b>: For rejected companion inputs, an operator-visible audit message is available within 1 second in at least 95% of cases during bench tests and field trials.</li>
<li><b>SC-003</b>: Mission logging captures at least: arm/disarm, all mode changes, all safety rejections, operator commands, companion decisions, and gimbal changes, with timestamps; replay reconstructs a coherent timeline with correct ordering for 100% of recorded events.</li>
<li><b>SC-004</b>: On a 20-minute representative mission, the log stays within the configured storage budget and retains at least the last 3 missions without manual intervention (subject to storage budget clarification).</li>
<li><b>SC-005</b>: Mission export of a 20-minute log completes in under 60 seconds over the standard operator interface in bench tests.</li>
<li><b>SC-006</b>: In fixed mode, gimbal holds commanded pitch/yaw within ±2° under static conditions; in follow-heading, yaw tracks heading changes with latency under 300 ms and steady-state error under ±3°; in sweep, the gimbal covers the configured bounds within ±5° and maintains rate within ±15%.</li>
<li><b>SC-007</b>: Tampered mission exports (any byte modified) are detected with 100% success via HMAC verification during validation tests. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on <span class="timestamp"></span> for ACP - Autonomous Command Protocol by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.15.0 </li>
  </ul>
</div>
</body>
</html>
