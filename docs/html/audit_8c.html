<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.15.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ACP - Autonomous Command Protocol: /Users/paulzanna/Github/Scout/src/services/audit.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ACP - Autonomous Command Protocol<span id="projectnumber">&#160;v0.3.0</span>
   </div>
   <div id="projectbrief">Portable C99 framing library with COBS, CRC16, and HMAC-SHA256 authentication</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.15.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('audit_8c.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">audit.c File Reference</div></div>
</div><!--header-->
<div class="contents">

<p>Companion input mediation and audit trail service.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;audit.h&quot;</code><br />
<code>#include &quot;feature_config.h&quot;</code><br />
<code>#include &quot;ringbuf.h&quot;</code><br />
<code>#include &quot;<a class="el" href="gcs__gateway_8h_source.html">gcs_gateway.h</a>&quot;</code><br />
<code>#include &quot;mode_manager.h&quot;</code><br />
<code>#include &quot;safety_manager.h&quot;</code><br />
<code>#include &quot;failsafe.h&quot;</code><br />
<code>#include &quot;esp_log.h&quot;</code><br />
<code>#include &quot;freertos/FreeRTOS.h&quot;</code><br />
<code>#include &quot;freertos/semphr.h&quot;</code><br />
<code>#include &lt;string.h&gt;</code><br />
<code>#include &lt;stdio.h&gt;</code><br />
</div>
<p><a href="audit_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 id="header-func-members" class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:acffead0575f888f3141967122fabe459" id="r_acffead0575f888f3141967122fabe459"><td class="memItemLeft" align="right" valign="top">static esp_err_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#acffead0575f888f3141967122fabe459">classify_companion_input</a> (const char *payload_summary, companion_classification_t *classification)</td></tr>
<tr class="memitem:ab1bf21443f51c3037823c024d9e21687" id="r_ab1bf21443f51c3037823c024d9e21687"><td class="memItemLeft" align="right" valign="top">static esp_err_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ab1bf21443f51c3037823c024d9e21687">evaluate_safety_gates</a> (const char *payload_summary, safety_evaluation_t *evaluation)</td></tr>
<tr class="memitem:a7207ed67e8e966cd0e28faca8f80e574" id="r_a7207ed67e8e966cd0e28faca8f80e574"><td class="memItemLeft" align="right" valign="top">static esp_err_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a7207ed67e8e966cd0e28faca8f80e574">log_audit_event</a> (const companion_input_t *input, const safety_evaluation_t *evaluation)</td></tr>
<tr class="memitem:a7c182d5ec4762119c7fa7cecd4d0b586" id="r_a7c182d5ec4762119c7fa7cecd4d0b586"><td class="memItemLeft" align="right" valign="top">static bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a7c182d5ec4762119c7fa7cecd4d0b586">is_source_whitelisted</a> (const char *source_identity)</td></tr>
<tr class="memitem:a1872a9136b33761c991ecf6c8824cd42" id="r_a1872a9136b33761c991ecf6c8824cd42"><td class="memItemLeft" align="right" valign="top">static int64_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a1872a9136b33761c991ecf6c8824cd42">get_timestamp_ms</a> (void)</td></tr>
<tr class="memitem:a49741203fef1c0d3c00c3f8995ffa266" id="r_a49741203fef1c0d3c00c3f8995ffa266"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a49741203fef1c0d3c00c3f8995ffa266">send_audit_summary</a> (const companion_input_t *input)</td></tr>
<tr class="memitem:a940c82bd44dd43dc925cbe55815a266a" id="r_a940c82bd44dd43dc925cbe55815a266a"><td class="memItemLeft" align="right" valign="top">esp_err_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a940c82bd44dd43dc925cbe55815a266a">audit_init</a> (void)</td></tr>
<tr class="memdesc:a940c82bd44dd43dc925cbe55815a266a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize the audit service.  <br /></td></tr>
<tr class="memitem:a97b817fa54cdab8b7242a94cc851a06c" id="r_a97b817fa54cdab8b7242a94cc851a06c"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a97b817fa54cdab8b7242a94cc851a06c">audit_deinit</a> (void)</td></tr>
<tr class="memdesc:a97b817fa54cdab8b7242a94cc851a06c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Shutdown the audit service.  <br /></td></tr>
<tr class="memitem:ae3e955769db62345c6f38019757d44be" id="r_ae3e955769db62345c6f38019757d44be"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ae3e955769db62345c6f38019757d44be">audit_is_initialized</a> (void)</td></tr>
<tr class="memdesc:ae3e955769db62345c6f38019757d44be"><td class="mdescLeft">&#160;</td><td class="mdescRight">Check if audit service is initialized.  <br /></td></tr>
<tr class="memitem:aa3d8d6037740110133b38af963635b6e" id="r_aa3d8d6037740110133b38af963635b6e"><td class="memItemLeft" align="right" valign="top">esp_err_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#aa3d8d6037740110133b38af963635b6e">audit_set_companion_whitelist</a> (const char *source_identity)</td></tr>
<tr class="memdesc:aa3d8d6037740110133b38af963635b6e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Set the whitelisted companion source.  <br /></td></tr>
<tr class="memitem:abf49b65634438683f3425d88dc8d10a1" id="r_abf49b65634438683f3425d88dc8d10a1"><td class="memItemLeft" align="right" valign="top">esp_err_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#abf49b65634438683f3425d88dc8d10a1">audit_process_companion_input</a> (const char *source_identity, const char *payload_summary, const char *correlation_id, safety_decision_t *result)</td></tr>
<tr class="memdesc:abf49b65634438683f3425d88dc8d10a1"><td class="mdescLeft">&#160;</td><td class="mdescRight">Process companion input through safety gateway.  <br /></td></tr>
<tr class="memitem:a5d00282383d65fb1484603124d4463ea" id="r_a5d00282383d65fb1484603124d4463ea"><td class="memItemLeft" align="right" valign="top">esp_err_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a5d00282383d65fb1484603124d4463ea">audit_get_recent_entries</a> (companion_input_t *entries, size_t max_entries, size_t *actual_count)</td></tr>
<tr class="memdesc:a5d00282383d65fb1484603124d4463ea"><td class="mdescLeft">&#160;</td><td class="mdescRight">Get recent audit entries.  <br /></td></tr>
<tr class="memitem:a6298bdf4b82a5ac2b2db4d1a6f759e5d" id="r_a6298bdf4b82a5ac2b2db4d1a6f759e5d"><td class="memItemLeft" align="right" valign="top">esp_err_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a6298bdf4b82a5ac2b2db4d1a6f759e5d">audit_get_companion_whitelist</a> (char *source_buffer, size_t buffer_size)</td></tr>
<tr class="memdesc:a6298bdf4b82a5ac2b2db4d1a6f759e5d"><td class="mdescLeft">&#160;</td><td class="mdescRight">Get current companion whitelist.  <br /></td></tr>
<tr class="memitem:aea40b9b5038a766fa6f02801d5942fd3" id="r_aea40b9b5038a766fa6f02801d5942fd3"><td class="memItemLeft" align="right" valign="top">esp_err_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#aea40b9b5038a766fa6f02801d5942fd3">audit_clear_companion_whitelist</a> (void)</td></tr>
<tr class="memdesc:aea40b9b5038a766fa6f02801d5942fd3"><td class="mdescLeft">&#160;</td><td class="mdescRight">Clear the companion whitelist.  <br /></td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 id="header-var-members" class="groupheader"><a id="var-members" name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a5a85b9c772bbeb480b209a3e6ea92b4c" id="r_a5a85b9c772bbeb480b209a3e6ea92b4c"><td class="memItemLeft" align="right" valign="top">static const char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a5a85b9c772bbeb480b209a3e6ea92b4c">TAG</a> = &quot;audit&quot;</td></tr>
<tr class="memitem:af9ab268f6acd99e115450af08f192f65" id="r_af9ab268f6acd99e115450af08f192f65"><td class="memItemLeft" align="right" valign="top">static bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#af9ab268f6acd99e115450af08f192f65">s_audit_initialized</a> = false</td></tr>
<tr class="memitem:a33cfa79538f0ee8ec003746f895b2ba3" id="r_a33cfa79538f0ee8ec003746f895b2ba3"><td class="memItemLeft" align="right" valign="top">static SemaphoreHandle_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a33cfa79538f0ee8ec003746f895b2ba3">s_audit_mutex</a> = NULL</td></tr>
<tr class="memitem:abe36df76053f2d19d291b09de5bc20bd" id="r_abe36df76053f2d19d291b09de5bc20bd"><td class="memItemLeft" align="right" valign="top">static char&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#abe36df76053f2d19d291b09de5bc20bd">s_whitelisted_source</a> [32] = {0}</td></tr>
<tr class="memitem:ab4a06ac4c65f03b21e2dad189c184cc6" id="r_ab4a06ac4c65f03b21e2dad189c184cc6"><td class="memItemLeft" align="right" valign="top">static bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ab4a06ac4c65f03b21e2dad189c184cc6">s_whitelist_active</a> = false</td></tr>
<tr class="memitem:ae2023cd257fc688a412c2b309675114d" id="r_ae2023cd257fc688a412c2b309675114d"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="structringbuf__t.html">ringbuf_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ae2023cd257fc688a412c2b309675114d">s_audit_ringbuf</a></td></tr>
<tr class="memitem:ac218fa170d68ced6132a4b7aaae57977" id="r_ac218fa170d68ced6132a4b7aaae57977"><td class="memItemLeft" align="right" valign="top">static bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ac218fa170d68ced6132a4b7aaae57977">s_ringbuf_initialized</a> = false</td></tr>
<tr class="memitem:ad94f2cacf2b468674cdc85484778bd09" id="r_ad94f2cacf2b468674cdc85484778bd09"><td class="memItemLeft" align="right" valign="top">static void *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ad94f2cacf2b468674cdc85484778bd09">s_audit_buf_ptrs</a> [AUDIT_EVENT_BUFFER_SIZE]</td></tr>
<tr class="memitem:ae4e8c0f9efbb3515f9948e8e5304278f" id="r_ae4e8c0f9efbb3515f9948e8e5304278f"><td class="memItemLeft" align="right" valign="top">static uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ae4e8c0f9efbb3515f9948e8e5304278f">s_audit_data_block</a> [AUDIT_EVENT_BUFFER_SIZE *sizeof(companion_input_t)]</td></tr>
</table>
<a name="details" id="details"></a><h2 id="header-details" class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Companion input mediation and audit trail service. </p>
<p>This service implements the companion mediation gateway that ensures all external companion device inputs undergo proper safety evaluation before being allowed to affect vehicle behavior. Provides comprehensive audit trails for accountability and forensic analysis.</p>
<p>Core Functions:</p><ul>
<li>Source whitelist enforcement (single authorized companion)</li>
<li>Command vs suggestion classification</li>
<li>Multi-layer safety gate evaluation (arming, mode, geofence, altitude)</li>
<li>Comprehensive audit logging with structured reason codes</li>
<li>Real-time operator visibility via telemetry summaries</li>
</ul>
<p>Safety Architecture:</p><ul>
<li>Input gateway blocks all non-whitelisted sources immediately</li>
<li>Safety evaluation includes arming state, flight mode, geofence, altitude</li>
<li>All decisions logged with detailed reason codes for analysis</li>
<li>Rate-limited telemetry prevents audit log flooding attacks</li>
</ul>
<p>Audit Trail Properties:</p><ul>
<li>Non-repudiation: All inputs logged with source identity</li>
<li>Chronological: Timestamp-ordered event sequence</li>
<li>Comprehensive: Both accepted and rejected commands logged</li>
<li>Structured: Machine-parseable reason codes and safety flags</li>
</ul>
<p>Performance Characteristics:</p><ul>
<li>Input evaluation: &lt;500us typical latency</li>
<li>Memory footprint: ~8KB ring buffer + minimal state</li>
<li>No blocking operations (queued background processing)</li>
<li>Rate limiting: 2 msgs/sec telemetry, 500ms coalescing</li>
</ul>
<p>Constitution Compliance:</p><ul>
<li>Safety: All companion inputs mediated through safety gates</li>
<li>Real-time: Non-blocking evaluation with background telemetry</li>
<li>Observability: Operator-visible audit within 1 second</li>
<li>Testability: Structured outputs for automated validation</li>
</ul>
<dl class="section author"><dt>Author</dt><dd>Scout Firmware Team </dd></dl>
<dl class="section date"><dt>Date</dt><dd>2025-10-26 </dd></dl>
<dl class="section version"><dt>Version</dt><dd>1.0 </dd></dl>

<p class="definition">Definition in file <a class="el" href="audit_8c_source.html">audit.c</a>.</p>
</div><a name="doc-func-members" id="doc-func-members"></a><h2 id="header-doc-func-members" class="groupheader">Function Documentation</h2>
<a id="aea40b9b5038a766fa6f02801d5942fd3" name="aea40b9b5038a766fa6f02801d5942fd3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aea40b9b5038a766fa6f02801d5942fd3">&#9670;&#160;</a></span>audit_clear_companion_whitelist()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">esp_err_t audit_clear_companion_whitelist </td>
          <td>(</td>
          <td class="paramtype">void</td>          <td class="paramname"><span class="paramname"><em></em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Clear the companion whitelist. </p>
<p>After clearing, all companion inputs will be rejected.</p>
<dl class="section return"><dt>Returns</dt><dd>ESP_OK on success </dd></dl>

<p class="definition">Definition at line <a class="el" href="audit_8c_source.html#l00340">340</a> of file <a class="el" href="audit_8c_source.html">audit.c</a>.</p>

</div>
</div>
<a id="a97b817fa54cdab8b7242a94cc851a06c" name="a97b817fa54cdab8b7242a94cc851a06c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a97b817fa54cdab8b7242a94cc851a06c">&#9670;&#160;</a></span>audit_deinit()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void audit_deinit </td>
          <td>(</td>
          <td class="paramtype">void</td>          <td class="paramname"><span class="paramname"><em></em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Shutdown the audit service. </p>

<p class="definition">Definition at line <a class="el" href="audit_8c_source.html#l00127">127</a> of file <a class="el" href="audit_8c_source.html">audit.c</a>.</p>

</div>
</div>
<a id="a6298bdf4b82a5ac2b2db4d1a6f759e5d" name="a6298bdf4b82a5ac2b2db4d1a6f759e5d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6298bdf4b82a5ac2b2db4d1a6f759e5d">&#9670;&#160;</a></span>audit_get_companion_whitelist()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">esp_err_t audit_get_companion_whitelist </td>
          <td>(</td>
          <td class="paramtype">char *</td>          <td class="paramname"><span class="paramname"><em>source_buffer</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t</td>          <td class="paramname"><span class="paramname"><em>buffer_size</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Get current companion whitelist. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">source_buffer</td><td>Buffer to store source identity </td></tr>
    <tr><td class="paramname">buffer_size</td><td>Size of source_buffer </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>ESP_OK if whitelist exists, ESP_ERR_NOT_FOUND if no whitelist set </dd></dl>

<p class="definition">Definition at line <a class="el" href="audit_8c_source.html#l00316">316</a> of file <a class="el" href="audit_8c_source.html">audit.c</a>.</p>

</div>
</div>
<a id="a5d00282383d65fb1484603124d4463ea" name="a5d00282383d65fb1484603124d4463ea"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5d00282383d65fb1484603124d4463ea">&#9670;&#160;</a></span>audit_get_recent_entries()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">esp_err_t audit_get_recent_entries </td>
          <td>(</td>
          <td class="paramtype">companion_input_t *</td>          <td class="paramname"><span class="paramname"><em>entries</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t</td>          <td class="paramname"><span class="paramname"><em>max_entries</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t *</td>          <td class="paramname"><span class="paramname"><em>actual_count</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Get recent audit entries. </p>
<p>Retrieves the most recent companion input audit entries. Used by CLI 'audit show' command.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">entries</td><td>Array to store audit entries </td></tr>
    <tr><td class="paramname">max_entries</td><td>Maximum number of entries to retrieve </td></tr>
    <tr><td class="paramname">actual_count</td><td>Pointer to store actual number retrieved </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>ESP_OK on success, error code otherwise </dd></dl>

<p class="definition">Definition at line <a class="el" href="audit_8c_source.html#l00276">276</a> of file <a class="el" href="audit_8c_source.html">audit.c</a>.</p>

</div>
</div>
<a id="a940c82bd44dd43dc925cbe55815a266a" name="a940c82bd44dd43dc925cbe55815a266a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a940c82bd44dd43dc925cbe55815a266a">&#9670;&#160;</a></span>audit_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">esp_err_t audit_init </td>
          <td>(</td>
          <td class="paramtype">void</td>          <td class="paramname"><span class="paramname"><em></em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initialize the audit service. </p>
<p>Sets up companion input gateway, whitelisting, and audit logging.</p>
<dl class="section return"><dt>Returns</dt><dd>ESP_OK on success, error code otherwise </dd></dl>

<p class="definition">Definition at line <a class="el" href="audit_8c_source.html#l00085">85</a> of file <a class="el" href="audit_8c_source.html">audit.c</a>.</p>

</div>
</div>
<a id="ae3e955769db62345c6f38019757d44be" name="ae3e955769db62345c6f38019757d44be"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae3e955769db62345c6f38019757d44be">&#9670;&#160;</a></span>audit_is_initialized()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool audit_is_initialized </td>
          <td>(</td>
          <td class="paramtype">void</td>          <td class="paramname"><span class="paramname"><em></em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Check if audit service is initialized. </p>
<dl class="section return"><dt>Returns</dt><dd>true if initialized, false otherwise </dd></dl>

<p class="definition">Definition at line <a class="el" href="audit_8c_source.html#l00162">162</a> of file <a class="el" href="audit_8c_source.html">audit.c</a>.</p>

<p class="reference">Referenced by <a class="el" href="gcs__gateway_8c_source.html#l00480">gcs_gateway_log_to_audit_system()</a>, and <a class="el" href="security__test_8c_source.html#l00862">test_audit_system_integration_with_companion()</a>.</p>

</div>
</div>
<a id="abf49b65634438683f3425d88dc8d10a1" name="abf49b65634438683f3425d88dc8d10a1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abf49b65634438683f3425d88dc8d10a1">&#9670;&#160;</a></span>audit_process_companion_input()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">esp_err_t audit_process_companion_input </td>
          <td>(</td>
          <td class="paramtype">const char *</td>          <td class="paramname"><span class="paramname"><em>source_identity</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *</td>          <td class="paramname"><span class="paramname"><em>payload_summary</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *</td>          <td class="paramname"><span class="paramname"><em>correlation_id</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">safety_decision_t *</td>          <td class="paramname"><span class="paramname"><em>result</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Process companion input through safety gateway. </p>
<p>This is the main entry point for all companion inputs. It performs:</p><ol type="1">
<li>Source identity verification against whitelist</li>
<li>Input classification (command vs suggestion)</li>
<li>Safety evaluation against all gates</li>
<li>Audit logging of decision and reasons</li>
</ol>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">source_identity</td><td>Source identifier </td></tr>
    <tr><td class="paramname">payload_summary</td><td>Human-readable command summary </td></tr>
    <tr><td class="paramname">correlation_id</td><td>Optional correlation ID </td></tr>
    <tr><td class="paramname">result</td><td>Pointer to store the gateway decision </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>ESP_OK if processed successfully, error code otherwise </dd></dl>

<p class="definition">Definition at line <a class="el" href="audit_8c_source.html#l00196">196</a> of file <a class="el" href="audit_8c_source.html">audit.c</a>.</p>

<p class="reference">Referenced by <a class="el" href="gcs__gateway_8c_source.html#l00480">gcs_gateway_log_to_audit_system()</a>, and <a class="el" href="security__test_8c_source.html#l00862">test_audit_system_integration_with_companion()</a>.</p>

</div>
</div>
<a id="aa3d8d6037740110133b38af963635b6e" name="aa3d8d6037740110133b38af963635b6e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa3d8d6037740110133b38af963635b6e">&#9670;&#160;</a></span>audit_set_companion_whitelist()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">esp_err_t audit_set_companion_whitelist </td>
          <td>(</td>
          <td class="paramtype">const char *</td>          <td class="paramname"><span class="paramname"><em>source_identity</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Set the whitelisted companion source. </p>
<p>Only one companion source is allowed at a time. Setting a new source replaces the previous whitelist entry.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">source_identity</td><td>Source identifier (e.g., "SYSID:123/COMPID:50") </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>ESP_OK on success, error code otherwise </dd></dl>

<p class="definition">Definition at line <a class="el" href="audit_8c_source.html#l00167">167</a> of file <a class="el" href="audit_8c_source.html">audit.c</a>.</p>

</div>
</div>
<a id="acffead0575f888f3141967122fabe459" name="acffead0575f888f3141967122fabe459"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acffead0575f888f3141967122fabe459">&#9670;&#160;</a></span>classify_companion_input()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">esp_err_t classify_companion_input </td>
          <td>(</td>
          <td class="paramtype">const char *</td>          <td class="paramname"><span class="paramname"><em>payload_summary</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">companion_classification_t *</td>          <td class="paramname"><span class="paramname"><em>classification</em></span>&#160;)</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="audit_8c_source.html#l00368">368</a> of file <a class="el" href="audit_8c_source.html">audit.c</a>.</p>

</div>
</div>
<a id="ab1bf21443f51c3037823c024d9e21687" name="ab1bf21443f51c3037823c024d9e21687"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab1bf21443f51c3037823c024d9e21687">&#9670;&#160;</a></span>evaluate_safety_gates()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">esp_err_t evaluate_safety_gates </td>
          <td>(</td>
          <td class="paramtype">const char *</td>          <td class="paramname"><span class="paramname"><em>payload_summary</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">safety_evaluation_t *</td>          <td class="paramname"><span class="paramname"><em>evaluation</em></span>&#160;)</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="audit_8c_source.html#l00390">390</a> of file <a class="el" href="audit_8c_source.html">audit.c</a>.</p>

</div>
</div>
<a id="a1872a9136b33761c991ecf6c8824cd42" name="a1872a9136b33761c991ecf6c8824cd42"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1872a9136b33761c991ecf6c8824cd42">&#9670;&#160;</a></span>get_timestamp_ms()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">int64_t get_timestamp_ms </td>
          <td>(</td>
          <td class="paramtype">void</td>          <td class="paramname"><span class="paramname"><em></em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="audit_8c_source.html#l00521">521</a> of file <a class="el" href="audit_8c_source.html">audit.c</a>.</p>

</div>
</div>
<a id="a7c182d5ec4762119c7fa7cecd4d0b586" name="a7c182d5ec4762119c7fa7cecd4d0b586"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7c182d5ec4762119c7fa7cecd4d0b586">&#9670;&#160;</a></span>is_source_whitelisted()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">bool is_source_whitelisted </td>
          <td>(</td>
          <td class="paramtype">const char *</td>          <td class="paramname"><span class="paramname"><em>source_identity</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="audit_8c_source.html#l00363">363</a> of file <a class="el" href="audit_8c_source.html">audit.c</a>.</p>

</div>
</div>
<a id="a7207ed67e8e966cd0e28faca8f80e574" name="a7207ed67e8e966cd0e28faca8f80e574"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7207ed67e8e966cd0e28faca8f80e574">&#9670;&#160;</a></span>log_audit_event()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">esp_err_t log_audit_event </td>
          <td>(</td>
          <td class="paramtype">const companion_input_t *</td>          <td class="paramname"><span class="paramname"><em>input</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const safety_evaluation_t *</td>          <td class="paramname"><span class="paramname"><em>evaluation</em></span>&#160;)</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="audit_8c_source.html#l00472">472</a> of file <a class="el" href="audit_8c_source.html">audit.c</a>.</p>

</div>
</div>
<a id="a49741203fef1c0d3c00c3f8995ffa266" name="a49741203fef1c0d3c00c3f8995ffa266"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a49741203fef1c0d3c00c3f8995ffa266">&#9670;&#160;</a></span>send_audit_summary()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void send_audit_summary </td>
          <td>(</td>
          <td class="paramtype">const companion_input_t *</td>          <td class="paramname"><span class="paramname"><em>input</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="audit_8c_source.html#l00495">495</a> of file <a class="el" href="audit_8c_source.html">audit.c</a>.</p>

</div>
</div>
<a name="doc-var-members" id="doc-var-members"></a><h2 id="header-doc-var-members" class="groupheader">Variable Documentation</h2>
<a id="ad94f2cacf2b468674cdc85484778bd09" name="ad94f2cacf2b468674cdc85484778bd09"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad94f2cacf2b468674cdc85484778bd09">&#9670;&#160;</a></span>s_audit_buf_ptrs</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void* s_audit_buf_ptrs[AUDIT_EVENT_BUFFER_SIZE]</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="audit_8c_source.html#l00074">74</a> of file <a class="el" href="audit_8c_source.html">audit.c</a>.</p>

</div>
</div>
<a id="ae4e8c0f9efbb3515f9948e8e5304278f" name="ae4e8c0f9efbb3515f9948e8e5304278f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae4e8c0f9efbb3515f9948e8e5304278f">&#9670;&#160;</a></span>s_audit_data_block</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t s_audit_data_block[AUDIT_EVENT_BUFFER_SIZE *sizeof(companion_input_t)]</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="audit_8c_source.html#l00075">75</a> of file <a class="el" href="audit_8c_source.html">audit.c</a>.</p>

</div>
</div>
<a id="af9ab268f6acd99e115450af08f192f65" name="af9ab268f6acd99e115450af08f192f65"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af9ab268f6acd99e115450af08f192f65">&#9670;&#160;</a></span>s_audit_initialized</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">bool s_audit_initialized = false</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="audit_8c_source.html#l00063">63</a> of file <a class="el" href="audit_8c_source.html">audit.c</a>.</p>

</div>
</div>
<a id="a33cfa79538f0ee8ec003746f895b2ba3" name="a33cfa79538f0ee8ec003746f895b2ba3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a33cfa79538f0ee8ec003746f895b2ba3">&#9670;&#160;</a></span>s_audit_mutex</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">SemaphoreHandle_t s_audit_mutex = NULL</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="audit_8c_source.html#l00064">64</a> of file <a class="el" href="audit_8c_source.html">audit.c</a>.</p>

</div>
</div>
<a id="ae2023cd257fc688a412c2b309675114d" name="ae2023cd257fc688a412c2b309675114d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae2023cd257fc688a412c2b309675114d">&#9670;&#160;</a></span>s_audit_ringbuf</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structringbuf__t.html">ringbuf_t</a> s_audit_ringbuf</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="audit_8c_source.html#l00071">71</a> of file <a class="el" href="audit_8c_source.html">audit.c</a>.</p>

</div>
</div>
<a id="ac218fa170d68ced6132a4b7aaae57977" name="ac218fa170d68ced6132a4b7aaae57977"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac218fa170d68ced6132a4b7aaae57977">&#9670;&#160;</a></span>s_ringbuf_initialized</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">bool s_ringbuf_initialized = false</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="audit_8c_source.html#l00072">72</a> of file <a class="el" href="audit_8c_source.html">audit.c</a>.</p>

</div>
</div>
<a id="ab4a06ac4c65f03b21e2dad189c184cc6" name="ab4a06ac4c65f03b21e2dad189c184cc6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab4a06ac4c65f03b21e2dad189c184cc6">&#9670;&#160;</a></span>s_whitelist_active</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">bool s_whitelist_active = false</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="audit_8c_source.html#l00068">68</a> of file <a class="el" href="audit_8c_source.html">audit.c</a>.</p>

</div>
</div>
<a id="abe36df76053f2d19d291b09de5bc20bd" name="abe36df76053f2d19d291b09de5bc20bd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abe36df76053f2d19d291b09de5bc20bd">&#9670;&#160;</a></span>s_whitelisted_source</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">char s_whitelisted_source[32] = {0}</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="audit_8c_source.html#l00067">67</a> of file <a class="el" href="audit_8c_source.html">audit.c</a>.</p>

</div>
</div>
<a id="a5a85b9c772bbeb480b209a3e6ea92b4c" name="a5a85b9c772bbeb480b209a3e6ea92b4c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5a85b9c772bbeb480b209a3e6ea92b4c">&#9670;&#160;</a></span>TAG</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">const char* TAG = &quot;audit&quot;</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="audit_8c_source.html#l00060">60</a> of file <a class="el" href="audit_8c_source.html">audit.c</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a href="dir_f76dd88a88a2d119ab336e5933bd9b31.html">Scout</a></li><li class="navelem"><b>src</b></li><li class="navelem"><b>services</b></li><li class="navelem"><a href="audit_8c.html">audit.c</a></li>
    <li class="footer">Generated on <span class="timestamp"></span> for ACP - Autonomous Command Protocol by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.15.0 </li>
  </ul>
</div>
</body>
</html>
