<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.15.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ACP - Autonomous Command Protocol: AI Coder Prompt — Eunice v0.5.8 “Evidence Graph Hardening”</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ACP - Autonomous Command Protocol<span id="projectnumber">&#160;v0.3.0</span>
   </div>
   <div id="projectbrief">Portable C99 framing library with COBS, CRC16, and HMAC-SHA256 authentication</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.15.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('md__2_users_2paulzanna_2_github_2_eunice_2docs_2_architecture_2coder__prompts_2eunice__v0_85_88__coder__prompt.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">AI Coder Prompt — Eunice v0.5.8 “Evidence Graph Hardening” </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md786"></a></p>
<p><b>Date:</b> 12-08-2025 <br  />
 <b>Role:</b> You are a senior software engineer implementing v0.5.8. Build exactly what is specified, create small PRs, and prove determinism and citation faithfulness with automated tests.</p>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md788"></a>
0) Mission</h1>
<p>Implement v0.5.8 to deliver <b>deterministic, citation-faithful literature outputs</b> backed by a <b>canonical Evidence Graph</b> with page/section <b>anchors</b>, <b>near-duplicate collapse</b>, <b>externalised prompts</b>, and a <b>deterministic cache</b>.</p>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md790"></a>
1) Constraints &amp; Standards</h1>
<ul>
<li>Python 3.11+, FastAPI (internal only), SQLAlchemy, Alembic, pytest, mypy, ruff.</li>
<li>Local-first; no embedded prompt strings. All prompts live in <span class="tt">prompts/*.json</span>.</li>
<li>Deterministic runs: seedable, cache keyed by <span class="tt">(stage, input-hash, prompt-hash, model-id, tool-version)</span>.</li>
<li>MCP connectors for sources (PubMed, arXiv, Semantic Scholar, CORE, Crossref).</li>
<li>Reproducibility: export run manifests; content-addressed artefacts under <span class="tt">.eunice/artifacts/</span>.</li>
<li>Licences respected: metadata-first; fetch PDFs/HTML only when allowed; record licence flags.</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md792"></a>
2) Deliverables (DoD must pass CI)</h1>
<ol type="1">
<li><b>Connectors &amp; Normalisers</b> (PubMed, arXiv, SS, CORE, Crossref) via MCP with retries/backoff.</li>
<li><b>Canonicalisation &amp; Dedup</b> with DOI→arXiv→PMID→URL priority; fuzzy title/author match.</li>
<li><b>PDF/HTML Anchor Extraction</b> with page, section_path, figure/caption, and quote spans + confidence.</li>
<li><b>Evidence Graph</b> persisted (<span class="tt">source</span>, <span class="tt">source_variant</span>, <span class="tt">source_anchor</span>, <span class="tt">claim</span>, <span class="tt">edge</span>, <span class="tt">prompt</span>, <span class="tt">run</span>).</li>
<li><b>Citation Weaver</b> wiring inline refs to <span class="tt">source_id#page</span> targets; broken-link detector.</li>
<li><b>Externalised Prompts</b> with JSON schema validation + SHA256 hashing.</li>
<li><b>Deterministic Cache</b> + run manifests; identical outputs on repeated runs.</li>
<li><b>Tests &amp; Benchmarks</b>: duplicate collapse ≥ 90%; anchor accuracy ≥ 95%; fully deterministic reruns.</li>
</ol>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md794"></a>
3) Repository Changes (expected layout)</h1>
<div class="fragment"><div class="line">/eunice</div>
<div class="line">  /connectors        # MCP client wrappers + normalisers</div>
<div class="line">  /pipeline          # stages: search, ingest, dedup, anchor, graph, render</div>
<div class="line">  /render            # report generator + citation weaving</div>
<div class="line">  /evidence          # graph models + writer</div>
<div class="line">  /db                # models + alembic</div>
<div class="line">  /cli               # click/typer CLI</div>
<div class="line">  /cache             # deterministic cache</div>
<div class="line">  /observability     # logs, metrics, run manifests</div>
<div class="line">/prompts             # *.json, schema-validated</div>
<div class="line">/config              # app.json + profiles</div>
<div class="line">/tests               # unit + property + golden topics</div>
</div><!-- fragment --><hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md796"></a>
4) Database Schema (Alembic migration)</h1>
<p>Tables: <span class="tt">source</span>, <span class="tt">source_variant</span>, <span class="tt">source_anchor</span>, <span class="tt">claim</span>, <span class="tt">edge</span>, <span class="tt">prompt</span>, <span class="tt">run</span>.</p>
<p>Key constraints:</p><ul>
<li><span class="tt">source(doi)</span> unique when not null; <span class="tt">source(arxiv_id)</span> unique when not null; <span class="tt">content_hash</span> indexed.</li>
<li><span class="tt">source_anchor(source_id, page, quote_start, quote_end)</span> partial unique when spans present.</li>
<li>FK: <span class="tt">edge.source_id -&gt; source.id</span>, <span class="tt">edge.claim_id -&gt; claim.id</span>, <span class="tt">edge.anchor_id -&gt; source_anchor.id</span>.</li>
<li><span class="tt">prompt.sha256</span> unique.</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md798"></a>
5) Algorithms</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md799"></a>
5.1 Canonicalisation &amp; Dedup</h2>
<ul>
<li>Priority: DOI → arXiv → PMID → URL content-hash.</li>
<li>Normalise title: lowercase, strip punctuation/stopwords, Unicode NFKD→NFC.</li>
<li>Compute: trigram Jaccard on title; author surname+initial overlap; year ±1 tolerance.</li>
<li>Thresholds (configurable): <span class="tt">t_title ≥ 0.88</span>, <span class="tt">t_authors ≥ 0.60</span>.</li>
<li>Collapse variants; strongest metadata wins; persist all <span class="tt">source_variant</span> rows.</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md800"></a>
5.2 Anchor Extraction</h2>
<ul>
<li>Parse PDFs (per-page text + heading hierarchy) / HTML.</li>
<li>Quote matching: exact→windowed→fuzzy (token-level Levenshtein); record offsets; compute confidence.</li>
<li>Anchors fields: <span class="tt">page</span>, <span class="tt">section_path</span>, <span class="tt">figure_id?</span>, <span class="tt">caption_text?</span>, <span class="tt">quote_start?</span>, <span class="tt">quote_end?</span>, <span class="tt">quote_text?</span>, <span class="tt">confidence</span>.</li>
<li>Flag anchors with <span class="tt">confidence &lt; 0.7</span> for re-run list.</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md801"></a>
5.3 Determinism &amp; Caching</h2>
<ul>
<li>Seed all stochastic ops; include prompt-hash &amp; model-id in cache keys.</li>
<li>Content-addressed files: SHA256 of bytes path under <span class="tt">.eunice/artifacts/</span>.</li>
</ul>
<p>Cache key function (reference): </p><div class="fragment"><div class="line"><span class="keyword">def </span>cache_key(stage, input_hash, prompt_hash, model_id, tool_versions):</div>
<div class="line">    <span class="keywordflow">return</span> sha256(f<span class="stringliteral">&quot;{stage}|{input_hash}|{prompt_hash}|{model_id}|{tool_versions}&quot;</span>)</div>
</div><!-- fragment --><hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md803"></a>
6) Interfaces</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md804"></a>
6.1 CLI</h2>
<ul>
<li><span class="tt">eunice search --topic "..."</span></li>
<li><span class="tt">eunice ingest --ids file.json</span></li>
<li><span class="tt">eunice dedup</span></li>
<li><span class="tt">eunice anchor</span></li>
<li><span class="tt">eunice evidence-graph build</span></li>
<li><span class="tt">eunice render --profile ug|msc|phd</span></li>
<li><span class="tt">eunice run --topic "..." --profile ug --seed 42</span></li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md805"></a>
6.2 Internal FastAPI (local only)</h2>
<div class="fragment"><div class="line">POST /ingest            -&gt; {records:[...]} -&gt; {source_ids:[...]}</div>
<div class="line">POST /dedup             -&gt; {} -&gt; {collapsed:int}</div>
<div class="line">POST /anchors/extract   -&gt; {source_id} -&gt; {anchors:[...]}</div>
<div class="line">POST /evidence-graph    -&gt; {claims:[...]} -&gt; {edges:[...]}</div>
<div class="line">POST /render            -&gt; {topic_id, profile} -&gt; {md, citations:[...]}</div>
<div class="line">GET  /runs/{id}         -&gt; {manifest}</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md806"></a>
6.3 MCP Tool Shapes</h2>
<div class="fragment"><div class="line">search({ query, limit, cursor? }) -&gt; { items:[{title, ids{doi?,arxiv?,pmid?}, url, year, authors[]}...] }</div>
<div class="line">get_metadata({ id|url })          -&gt; { normalized fields }</div>
<div class="line">get_fulltext({ id|url })          -&gt; { content: &lt;pdf|html bytes&gt;, content_type }</div>
</div><!-- fragment --><hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md808"></a>
7) Prompts &amp; Config</h1>
<ul>
<li>Move all prompts to <span class="tt">/prompts/*.json</span>; add JSON Schema and validation.</li>
<li>Compute <span class="tt">prompt.sha256</span> from canonical JSON (whitespace-insensitive).</li>
<li>Profiles under <span class="tt">/config/profiles/{ug,msc,phd}.json</span> (even if UG-only in 0.5.8).</li>
</ul>
<p>Prompt JSON example: </p><div class="fragment"><div class="line">{</div>
<div class="line">  &quot;name&quot;: &quot;summarise&quot;,</div>
<div class="line">  &quot;version&quot;: &quot;1.0&quot;,</div>
<div class="line">  &quot;role&quot;: &quot;You are a literature summariser focused on accurate attribution.&quot;,</div>
<div class="line">  &quot;inputs&quot;: [&quot;abstract&quot;, &quot;metadata&quot;],</div>
<div class="line">  &quot;style&quot;: {&quot;citations&quot;: &quot;numeric&quot;},</div>
<div class="line">  &quot;constraints&quot;: {&quot;max_tokens&quot;: 1500},</div>
<div class="line">  &quot;assertions&quot;: [&quot;always cite with source_id#page&quot;]</div>
<div class="line">}</div>
</div><!-- fragment --><hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md810"></a>
8) Tests (pytest) — must implement</h1>
<ul>
<li><b>Determinism:</b> same inputs → byte-identical <span class="tt">report.md</span> and <span class="tt">run_manifest.json</span>.</li>
<li><b>Dedup Property Tests:</b> perturb titles/authors/years; verify collapse holds under noise.</li>
<li><b>Anchor QA:</b> random K anchors; recompute match; assert accuracy ≥ 95% (configurable K).</li>
<li><b>Broken-link Detector:</b> corrupt an anchor; renderer must flag &amp; fail CI.</li>
<li><b>Golden Topics:</b> at least two topics with frozen expected outputs.</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md812"></a>
9) Acceptance Criteria (CI gates)</h1>
<ul>
<li>≥ 95% page-level anchor accuracy on sample K.</li>
<li>≥ 90% duplicate collapse on curated dup set.</li>
<li>Zero embedded prompt strings (grep guard passes).</li>
<li>Re-run after cache warm → identical outputs.</li>
<li>Run manifest includes input hashes, prompt hashes, model-id, tool versions, seed.</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md814"></a>
10) Work Plan (PRs)</h1>
<p><b>PR1: Connectors + Normalisers</b> <br  />
</p><ul>
<li>MCP clients, request throttling/backoff, normalised schema, unit tests.</li>
</ul>
<p><b>PR2: PDF/HTML Parsing + Anchors</b> <br  />
</p><ul>
<li>PDF per-page extraction, HTML paths, anchor model, confidence scoring, tests.</li>
</ul>
<p><b>PR3: Canonicalisation &amp; Dedup</b> <br  />
</p><ul>
<li>Heuristics + thresholds, variant tracking, property tests + curated dup set.</li>
</ul>
<p><b>PR4: Evidence Graph</b> <br  />
</p><ul>
<li>DB schema + writer; edges (supports|contradicts|cites); fixtures + tests.</li>
</ul>
<p><b>PR5: Citation Weaver</b> <br  />
</p><ul>
<li>Inline numeric refs → <span class="tt">source_id#page</span>; broken-link detector; renderer tests.</li>
</ul>
<p><b>PR6: External Prompts</b> <br  />
</p><ul>
<li>Loader + schema validation; SHA256 hashing; config wiring; grep guard.</li>
</ul>
<p><b>PR7: Deterministic Cache &amp; Manifests</b> <br  />
</p><ul>
<li>Cache module; run manifest export; determinism test.</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md816"></a>
11) Telemetry &amp; Artefacts</h1>
<ul>
<li>JSONL logs (per stage latencies, cache hits).</li>
<li>Artefacts: <span class="tt">anchors.json</span>, <span class="tt">evidence_graph.json</span>, <span class="tt">report.md</span>, <span class="tt">run_manifest.json</span> saved under <span class="tt">.eunice/artifacts/&lt;run-id&gt;/</span>.</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md818"></a>
12) Edge Cases</h1>
<ul>
<li>Multiple DOIs mapped to versions (preprint vs journal): prefer journal DOI; keep preprint as <span class="tt">source_variant</span>.</li>
<li>PDF updates changing pagination: detect by content hash change → re-anchor.</li>
<li>Non-Latin scripts and ligatures: normalise via Unicode NFC; adjust trigram logic if needed.</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md820"></a>
13) Runbook (developer)</h1>
<ol type="1">
<li>Create branch <span class="tt">feature/v0.5.8-evidence-graph</span>.</li>
<li>Add Alembic migration for new tables; run locally.</li>
<li>Implement PRs in order; add tests each PR; ensure CI green.</li>
<li>Validate on golden topics; snapshot artefacts.</li>
<li>Enable cache and determinism gates; finalise docs.</li>
</ol>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md822"></a>
14) Definition of Done</h1>
<ul>
<li>All CI gates green; acceptance thresholds met.</li>
<li>Re-runs deterministic; artefacts published.</li>
<li>Prompts externalised with hashes; no embedded strings.</li>
<li>Evidence graph exported and used by renderer.</li>
</ul>
<p>Implement now. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on <span class="timestamp"></span> for ACP - Autonomous Command Protocol by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.15.0 </li>
  </ul>
</div>
</body>
</html>
