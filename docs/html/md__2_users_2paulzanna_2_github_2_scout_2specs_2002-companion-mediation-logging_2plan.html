<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.15.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ACP - Autonomous Command Protocol: Implementation Plan: Companion Mediation, Blackbox Logging, and Gimbal Control</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ACP - Autonomous Command Protocol<span id="projectnumber">&#160;v0.3.0</span>
   </div>
   <div id="projectbrief">Portable C99 framing library with COBS, CRC16, and HMAC-SHA256 authentication</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.15.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('md__2_users_2paulzanna_2_github_2_scout_2specs_2002-companion-mediation-logging_2plan.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Implementation Plan: Companion Mediation, Blackbox Logging, and Gimbal Control </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md8667"></a></p>
<p><b>Branch</b>: <span class="tt">002-companion-mediation-logging</span> | <b>Date</b>: 2025-10-26 | <b>Spec</b>: specs/002-companion-mediation-logging/spec.md <b>Input</b>: Feature specification from <span class="tt">/specs/002-companion-mediation-logging/spec.md</span></p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md8668"></a>
Summary</h1>
<p>Implement three capabilities on the ESP32‑S3 flight controller: (1) Companion input mediation and auditable logging with strict source whitelisting and safety gates; (2) Field blackbox logging with per‑flight NDJSON logs, post‑flight replay, and export with HMAC‑SHA256; (3) Basic gimbal control (fixed, follow‑heading, search‑sweep) exposed via CLI and SCP, with operator status feedback. Technical approach prioritizes non‑blocking, rate‑limited background logging, CLI contracts aligned with existing patterns, and minimal telemetry bandwidth via coalesced summaries.</p>
<p>SCP v1.1 (telemetry/control mapping)</p>
<p><b>Language/Version</b>: C (GNU C11); ESP‑IDF 5.x via PlatformIO; FreeRTOS (bundled) <b>Primary Dependencies</b>: ESP‑IDF drivers (UART/SPI/I2C), NVS, FATFS partition, existing CLI framework, SCP v1.1 (telemetry/control mapping) <b>External Interfaces</b>: SCP command mapping for gimbal control; audit summaries via SCP telemetry with severity and rate limiting; no custom messages required beyond SCP initially. Compatibility documented; SITL/HIL optional logs if available. <b>Testing</b>: Bench test scripts + golden CLI transcripts; log export verification (HMAC) tests; integration checks with synthetic event bursts; optional HIL if available <b>Target Platform</b>: ESP32‑S3 (freenove_esp32_s3_wroom) <b>Project Type</b>: Embedded firmware (single project) <b>Performance Goals</b>: Maintain control loop timing; telemetry summaries ≤2 msgs/sec; gimbal latency &lt;300 ms; CPU &lt;70% in flight **Constraints**: No blocking I/O in hot paths; background tasks for file I/O; bounded memory use (prefer static/pools); single whitelisted companion identity **Scale/Scope**: Single vehicle; one mission retained; 2s sensor summaries; export NDJSON with HMAC authentication</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md8669"></a>
Constitution Check</h1>
<p>All gates addressed below; no violations expected. Re‑verify after Phase 1 design.</p>
<ul>
<li>Safety: Safety gates mediate all companion inputs; unauthorized sources rejected and logged (FR‑001..FR‑008). Manual test: attempt takeoff when disarmed and out‑of‑geofence waypoint—expect reject + operator audit within 1s. Arming/failsafe unchanged except improved observability.</li>
<li>Real‑time: Logging and telemetry summaries run in background tasks with rate limiting (FR‑006, FR‑032). No dynamic allocations in loops; file I/O buffered and deferred. Evidence to collect: `stats`/`status` CPU before/after; confirm p95 loop time unchanged and CPU &lt;70%.</li>
<li>CLI contracts: New commands: `audit show`, `mission list`, `mission replay &lt;id&gt; [&ndash;summary]<span class="tt">, </span>mission export &lt;id&gt;<span class="tt">, </span>gimbal mode &lt;fixed|follow|sweep&gt;<span class="tt">, </span>gimbal set &lt;pitch&gt; &lt;yaw&gt;<span class="tt">, </span>gimbal sweep &lt;min&gt; &lt;max&gt; &lt;rate&gt;<span class="tt">, </span>hmac set &lt;keyLabel&gt; &lt;hexKey&gt;<span class="tt">, </span>hmac show<span class="tt">. Compatibility: MINOR version bump (adds commands; no breakage to core contracts).
│   └── scp_gateway.c/.h      # Event summaries, gimbal mapping</span></li>
<li><span class="tt">Observability &amp; Docs: Blackbox NDJSON schema documented; </span>status<span class="tt">/</span>stats<span class="tt"> unaffected; docs for CLI, gimbal modes, and export verification added.</span></li>
<li><span class="tt">External Interfaces: MAVLink mapping for gimbal control via </span>MAV_CMD_DO_MOUNT_CONTROL<span class="tt">; audit summaries via </span>STATUSTEXT` with severity and rate limiting; no custom messages required initially. Compatibility documented; SITL/HIL optional logs if available.</li>
</ul>
<p>a small SCP gateway for summaries and gimbal mapping. Keep hot paths lean; put I/O in services.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8670"></a>
Documentation (this feature)</h2>
<div class="fragment"><div class="line">specs/002-companion-mediation-logging/</div>
<div class="line">├── plan.md</div>
<div class="line">├── research.md</div>
<div class="line">├── data-model.md</div>
<div class="line">├── quickstart.md</div>
<div class="line">└── contracts/</div>
<div class="line">    ├── cli.md</div>
<div class="line">    ├── mavlink.md</div>
<div class="line">    └── ndjson-schema.json</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md8671"></a>
Source Code (repository root)</h2>
<div class="fragment"><div class="line">src/</div>
<div class="line">├── main.c                    # Feature flags + init wiring</div>
<div class="line">├── cli/                      # CLI command handlers (new files)</div>
<div class="line">├── services/</div>
<div class="line">│   ├── audit.c/.h            # Companion mediation + audit logging</div>
<div class="line">│   ├── blackbox.c/.h         # Mission log writer, rotation, export</div>
<div class="line">│   └── gimbal.c/.h           # Gimbal mode control + status</div>
<div class="line">├── telemetry/</div>
<div class="line">│   └── scp_gateway.c/.h      # Event summaries, gimbal mapping</div>
<div class="line">└── lib/                      # Shared utils (HMAC, ring buffers)</div>
<div class="line"> </div>
<div class="line">tests/</div>
<div class="line">├── integration/</div>
<div class="line">└── contract/</div>
</div><!-- fragment --><p><b>Structure Decision</b>: Single embedded project. Add new service modules (audit, blackbox, gimbal), CLI handlers, and a small SCP gateway for summaries and gimbal mapping. Keep hot paths lean; put I/O in services.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md8672"></a>
Complexity Tracking</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Violation  </th><th class="markdownTableHeadNone">Why Needed  </th><th class="markdownTableHeadNone">Simpler Alternative Rejected Because  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">HMAC signature on exports  </td><td class="markdownTableBodyNone">Integrity/authenticity for mission evidence  </td><td class="markdownTableBodyNone">Plain checksum insufficient for tamper resistance  </td></tr>
</table>
<h1 class="doxsection"><a class="anchor" id="autotoc_md8673"></a>
Core implementation sequence (with references)</h1>
<p>1) Background logging infrastructure (writer + queue)</p><ul>
<li>Implement: <span class="tt"><a class="el" href="src_2services_2blackbox_8c.html" title="Mission blackbox logging service implementation.">src/services/blackbox.c</a>/.h</span> background task, bounded queue, file rotation (keep-last-1)</li>
<li>References: spec FR-010..FR-017; research §1, §7, §9; contracts/ndjson-schema.json; data-model.md (BlackboxEvent, MissionLog)</li>
<li>Acceptance: queue never blocks control loops; partial/corrupted logs handled (Edge Cases); SC-003, SC-004</li>
</ul>
<p>2) Companion input gateway and safety mediation</p><ul>
<li>Implement: <span class="tt"><a class="el" href="audit_8c.html" title="Companion input mediation and audit trail service.">src/services/audit.c</a>/.h</span> gateway API and safety checks; classification (command/suggestion); unauthorized source rejection (single whitelist)</li>
<li>References: spec FR-001..FR-008; research §6; data-model.md (CompanionInput, SafetyEvaluation)</li>
<li>Acceptance: disarmed takeoff and geofence breach rejected and logged; operator-visible audit within 1s (SC-002)</li>
</ul>
<p>3) Audit summaries and telemetry rate limiter</p><ul>
<li>Implement: <span class="tt"><a class="el" href="gcs__gateway__runtime_8c.html" title="Minimal runtime GCS Gateway implementation aligned with current SCP protocol.">src/services/gcs_gateway_runtime.c</a></span> emitting SCP audit summaries; 2 msg/sec cap with 500 ms coalescing</li>
<li>References: spec FR-030, FR-032; research §4; SCP audit summaries</li>
<li>Acceptance: synthetic burst ≥20 events/s results in ≤2 msgs/s; coalesced counts preserved (SC-008)</li>
</ul>
<p>4) Gimbal service and modes</p><ul>
<li>Implement: <span class="tt"><a class="el" href="gimbal_8c.html" title="Two-axis gimbal control service implementation.">src/services/gimbal.c</a>/.h</span> with modes: fixed, follow-heading, search-sweep (±135° at 10°/s defaults); slew limits and status</li>
<li>References: spec FR-020..FR-025, FR-023 defaults; research §5; SCP gimbal control mapping</li>
<li>Acceptance: fixed holds ±2°; follow-heading &lt;300 ms latency and ±3° steady-state; sweep bounds/rate within tolerances (SC-006)</li>
</ul>
<p>5) CLI command handlers</p><ul>
<li>Implement: <span class="tt">src/cli/</span> commands per contracts/cli.md: audit show, mission list/replay/export, hmac set/show, gimbal mode/set/sweep/status</li>
<li>References: spec FR-005, FR-012..FR-016, FR-031; contracts/cli.md; quickstart.md</li>
<li>Acceptance: golden transcripts for each command; human-readable and stable per Constitution III</li>
</ul>
<p>6) HMAC export signing and verification metadata</p><ul>
<li>Implement: HMAC-SHA256 utility in <span class="tt">src/lib/</span> and export footer metadata {algo, keyLabel, signature}; NVS key storage</li>
<li>References: spec FR-016, FR-018; research §2, §3; contracts/ndjson-schema.json (event), export footer (document in quickstart)</li>
<li>Acceptance: SC-007 tamper detection 100%; <span class="tt">hmac show</span> reveals label only</li>
</ul>
<p>7) Mission replay and summary</p><ul>
<li>Implement: <span class="tt">mission replay</span> reader over NDJSON (ordered by ts) printing human-readable timeline; <span class="tt">--summary</span> compacts similar entries</li>
<li>References: spec FR-013; data-model.md; quickstart.md</li>
<li>Acceptance: timeline reconstructs events in correct order for recorded items (SC-003)</li>
</ul>
<p>8) Performance and safety validation</p><ul>
<li>Implement: capture <span class="tt">status</span>/<span class="tt">stats</span> before/after; ensure CPU &lt;70%, loops unchanged; verify failsafes unaffected</li>
<li>References: Constitution I &amp; II; Success Criteria SC-001..SC-006; Quickstart checks</li>
<li>Acceptance: documented evidence in PR with snapshots and logs</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md8674"></a>
Traceability (requirements → artifacts)</h1>
<ul>
<li>Companion mediation &amp; audit (FR-001..FR-008)<ul>
<li>Code: <a class="el" href="audit_8c.html" title="Companion input mediation and audit trail service.">services/audit.c</a>, <a class="el" href="gcs__gateway__runtime_8c.html" title="Minimal runtime GCS Gateway implementation aligned with current SCP protocol.">services/gcs_gateway_runtime.c</a> (summaries)</li>
<li>Data: CompanionInput, SafetyEvaluation (data-model.md)</li>
<li>Contracts: cli.md (audit show)</li>
<li>Tests/Evidence: golden transcript, synthetic burst log (SC-002, SC-008)</li>
</ul>
</li>
<li>Blackbox logging &amp; replay (FR-010..FR-017)<ul>
<li>Code: <a class="el" href="src_2services_2blackbox_8c.html" title="Mission blackbox logging service implementation.">services/blackbox.c</a>, <a class="el" href="hmac_8c_source.html">lib/hmac.c</a> (for export metadata plumbing)</li>
<li>Data: BlackboxEvent, MissionLog (data-model.md); ndjson-schema.json</li>
<li>Contracts: cli.md (mission list/replay/export)</li>
<li>Tests/Evidence: replay transcript; storage rotation demo; SC-003..SC-005</li>
</ul>
</li>
<li>Export integrity (FR-018)<ul>
<li>Code: <a class="el" href="hmac_8c_source.html">lib/hmac.c</a>, <a class="el" href="src_2services_2blackbox_8c.html" title="Mission blackbox logging service implementation.">services/blackbox.c</a> (footer write)</li>
<li>Contracts: quickstart.md (verification steps)</li>
<li>Tests/Evidence: tamper test (SC-007)</li>
</ul>
</li>
<li>Gimbal control (FR-020..FR-025)<ul>
<li>Code: <a class="el" href="gimbal_8c.html" title="Two-axis gimbal control service implementation.">services/gimbal.c</a>, telemetry/mavlink_bridge.c (MAV_CMD_DO_MOUNT_CONTROL)</li>
<li>Contracts: cli.md (gimbal commands), mavlink.md (control mapping)</li>
<li>Tests/Evidence: bench angle measurements vs tolerances (SC-006)</li>
</ul>
</li>
<li>Operator visibility &amp; telemetry (FR-030..FR-032)<ul>
<li>Code: telemetry/mavlink_bridge.c (rate limiter/coalescer)</li>
<li>Contracts: mavlink.md (STATUSTEXT), quickstart.md (expected behavior)</li>
<li>Tests/Evidence: burst test (SC-008)</li>
</ul>
</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md8675"></a>
Non-goals (for this feature)</h1>
<ul>
<li>Advanced gimbal stabilization or sensor fusion control loops</li>
<li>Custom MAVLink messages for structured audit (may revisit later)</li>
<li>Multi-source companion arbitration (single whitelisted source only)</li>
<li>Long-term mission retention beyond keep-last-1 </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on <span class="timestamp"></span> for ACP - Autonomous Command Protocol by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.15.0 </li>
  </ul>
</div>
</body>
</html>
