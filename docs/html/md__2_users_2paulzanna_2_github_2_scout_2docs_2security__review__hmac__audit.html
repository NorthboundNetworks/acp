<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.15.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ACP - Autonomous Command Protocol: Security Review: HMAC Key Handling and Audit Logging</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ACP - Autonomous Command Protocol<span id="projectnumber">&#160;v0.3.0</span>
   </div>
   <div id="projectbrief">Portable C99 framing library with COBS, CRC16, and HMAC-SHA256 authentication</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.15.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('md__2_users_2paulzanna_2_github_2_scout_2docs_2security__review__hmac__audit.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Security Review: HMAC Key Handling and Audit Logging </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md8287"></a></p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md8288"></a>
Created: 2025-10-26</h1>
<h1 class="doxsection"><a class="anchor" id="autotoc_md8289"></a>
Feature: Companion Mediation, Blackbox Logging, and Gimbal Control</h1>
<h1 class="doxsection"><a class="anchor" id="autotoc_md8290"></a>
Focus: Security best practices for cryptographic keys and audit trails</h1>
<h1 class="doxsection"><a class="anchor" id="autotoc_md8291"></a>
Executive Summary</h1>
<p>This security review evaluates the HMAC key handling system and companion audit logging for vulnerabilities, compliance with security best practices, and resistance to common attack vectors. The implementation demonstrates strong security practices with several areas for future enhancement.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md8292"></a>
Overall Security Rating: GOOD</h1>
<ul>
<li>✅ Key storage uses hardware-backed NVS</li>
<li>✅ Unauthorized access is properly logged <br  />
</li>
<li>✅ No key material exposure in logs</li>
<li>⚠️ Key rotation not implemented (acceptable for current scope)</li>
<li>⚠️ No key derivation functions (acceptable for mission-specific keys)</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md8293"></a>
HMAC Key Storage Security Analysis</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8294"></a>
Positive Security Practices</h2>
<ol type="1">
<li><b>Hardware-Backed Storage (NVS)</b><ul>
<li>Keys stored in ESP32-S3 NVS partition with flash encryption</li>
<li>Automatic hardware encryption when flash encryption enabled</li>
<li>Keys persist across reboots but not in plaintext memory</li>
</ul>
</li>
<li><b>Key Access Control</b><ul>
<li>Label-based key retrieval prevents unauthorized key access</li>
<li>Key existence check without exposing key material</li>
<li>Proper error handling prevents information leakage</li>
</ul>
</li>
<li><b>Secure Key Lifecycle</b><ul>
<li>Atomic key storage (both label and data or neither)</li>
<li>Secure key removal with verification</li>
<li>No temporary key exposure during operations</li>
</ul>
</li>
</ol>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8295"></a>
Security Code Review</h2>
<p><b>File: <span class="tt"><a class="el" href="hmac__kv_8c_source.html">src/lib/hmac_kv.c</a></span></b></p>
<p><b>SECURE</b>: Key storage function properly validates inputs</p>
<div class="fragment"><div class="line">esp_err_t hmac_kv_set_key(<span class="keyword">const</span> <span class="keywordtype">char</span> *key_label, <span class="keyword">const</span> <span class="keywordtype">char</span> *key_data, <span class="keywordtype">size_t</span> key_len)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// ✅ Input validation prevents buffer overflows</span></div>
<div class="line">    <span class="keywordflow">if</span> (key_label == NULL || key_data == NULL || key_len == 0) {</div>
<div class="line">        <span class="keywordflow">return</span> ESP_ERR_INVALID_ARG;</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// ✅ No key material in logs - only labels logged</span></div>
<div class="line">    ESP_LOGI(TAG, <span class="stringliteral">&quot;Storing HMAC key with label: %s&quot;</span>, key_label);</div>
</div><!-- fragment --><p><b>SECURE</b>: Key retrieval requires exact label match</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (strcmp(key_label, stored_label) != 0) {</div>
<div class="line">    ESP_LOGW(TAG, <span class="stringliteral">&quot;Requested key label &#39;%s&#39; does not match stored label &#39;%s&#39;&quot;</span>,</div>
<div class="line">             key_label, stored_label);</div>
<div class="line">    <span class="keywordflow">return</span> ESP_ERR_NOT_FOUND;  <span class="comment">// ✅ Prevents unauthorized key access</span></div>
<div class="line">}</div>
</div><!-- fragment --><p><b>SECURE</b>: Key removal requires verification</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (strcmp(key_label, stored_label) != 0) {</div>
<div class="line">    ESP_LOGW(TAG, <span class="stringliteral">&quot;Cannot remove key: label mismatch&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> ESP_ERR_NOT_FOUND;  <span class="comment">// ✅ Prevents unauthorized key deletion</span></div>
<div class="line">}</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md8296"></a>
Potential Security Enhancements</h2>
<ol type="1">
<li><b>Key Derivation (Future)</b><ul>
<li>Consider PBKDF2 or Argon2 for user-provided keys</li>
<li>Current hex input acceptable for mission-generated keys</li>
</ul>
</li>
<li><b>Key Rotation (Future)</b><ul>
<li>Implement automatic key rotation for long-term missions</li>
<li>Current single-key model sufficient for short missions</li>
</ul>
</li>
<li><b>Access Logging</b><ul>
<li>Add audit trail for key access attempts (beyond current label mismatches)</li>
</ul>
</li>
</ol>
<h1 class="doxsection"><a class="anchor" id="autotoc_md8297"></a>
Companion Audit Logging Security Analysis</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8298"></a>
Security Architecture Review</h2>
<p><b>File: <span class="tt"><a class="el" href="audit_8c.html" title="Companion input mediation and audit trail service.">src/services/audit.c</a></span></b></p>
<p><b>SECURE</b>: Unauthorized source detection and logging</p>
<div class="fragment"><div class="line"><span class="comment">// ✅ Proper whitelist enforcement</span></div>
<div class="line"><span class="keywordflow">if</span> (!is_source_authorized(source_identity)) {</div>
<div class="line">    input.evaluation_result = EVAL_RESULT_REJECTED;</div>
<div class="line">    input.safety_flags |= SAFETY_FLAG_UNAUTHORIZED_SOURCE;</div>
<div class="line">    strncpy(input.reason_codes, <span class="stringliteral">&quot;unauthorized_source&quot;</span>, <span class="keyword">sizeof</span>(input.reason_codes) - 1);</div>
<div class="line">    ESP_LOGW(TAG, <span class="stringliteral">&quot;Rejected companion input from unauthorized source: %s&quot;</span>, source_identity);</div>
<div class="line">    <span class="comment">// ✅ Security event properly logged for forensics</span></div>
<div class="line">}</div>
</div><!-- fragment --><p><b>SECURE</b>: Input sanitization and validation</p>
<div class="fragment"><div class="line"><span class="comment">// ✅ Buffer overflow protection</span></div>
<div class="line">strncpy(input.source_identity, source_identity, <span class="keyword">sizeof</span>(input.source_identity) - 1);</div>
<div class="line">input.source_identity[<span class="keyword">sizeof</span>(input.source_identity) - 1] = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// ✅ Command classification prevents injection</span></div>
<div class="line">input.command_type = classify_companion_input(scp_msg);</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md8299"></a>
Audit Trail Security Properties</h2>
<ol type="1">
<li><b>Non-Repudiation</b><ul>
<li>✅ All companion inputs logged with source identity</li>
<li>✅ Timestamps provide chronological audit trail</li>
<li>✅ Both accepted and rejected commands logged</li>
</ul>
</li>
<li><b>Integrity Protection</b><ul>
<li>✅ HMAC signatures on exported mission logs</li>
<li>✅ Tamper detection through signature verification</li>
<li>✅ Structured NDJSON format prevents log injection</li>
</ul>
</li>
<li><b>Confidentiality</b><ul>
<li>✅ No sensitive data (keys, passwords) in audit logs</li>
<li>✅ Mission-specific data only (waypoints, commands)</li>
<li>✅ Source identity logging for accountability</li>
</ul>
</li>
</ol>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8300"></a>
Security Incident Response</h2>
<p><b>Unauthorized Access Handling</b>:</p>
<div class="fragment"><div class="line"><span class="comment">// ✅ Immediate rejection and logging</span></div>
<div class="line">input.evaluation_result = EVAL_RESULT_REJECTED;</div>
<div class="line"><span class="comment">// ✅ Security flag for automated detection</span></div>
<div class="line">input.safety_flags |= SAFETY_FLAG_UNAUTHORIZED_SOURCE;</div>
<div class="line"><span class="comment">// ✅ Human-readable reason for operators</span></div>
<div class="line">strncpy(input.reason_codes, <span class="stringliteral">&quot;unauthorized_source&quot;</span>, <span class="keyword">sizeof</span>(input.reason_codes) - 1);</div>
</div><!-- fragment --><p><b>Rate Limiting Protection</b>:</p>
<div class="fragment"><div class="line"><span class="comment">// ✅ Prevents audit log flooding attacks</span></div>
<div class="line"><span class="preprocessor">#define TELEMETRY_AUDIT_MAX_RATE_MSG_PER_SEC 2</span></div>
<div class="line"><span class="preprocessor">#define TELEMETRY_AUDIT_COALESCE_WINDOW_MS 500</span></div>
</div><!-- fragment --><h1 class="doxsection"><a class="anchor" id="autotoc_md8301"></a>
Attack Vector Analysis</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8302"></a>
1. Key Extraction Attacks</h2>
<p><b>Attack</b>: Physical access to device attempting key extraction</p>
<ul>
<li><b>Mitigation</b>: NVS flash encryption (when enabled)</li>
<li><b>Residual Risk</b>: LOW (requires specialized hardware)</li>
<li><b>Recommendation</b>: Enable flash encryption in production builds</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8303"></a>
2. Unauthorized Companion Impersonation</h2>
<p><b>Attack</b>: Rogue companion device attempting to send commands</p>
<ul>
<li><b>Mitigation</b>: Source whitelist with exact identity matching</li>
<li><b>Residual Risk</b>: LOW (requires knowledge of whitelisted identity)</li>
<li><b>Evidence</b>: Properly logged and rejected in audit trail</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8304"></a>
3. Audit Log Tampering</h2>
<p><b>Attack</b>: Modification of mission logs to hide malicious activity</p>
<ul>
<li><b>Mitigation</b>: HMAC-SHA256 signatures on exported logs</li>
<li><b>Residual Risk</b>: LOW (requires key compromise)</li>
<li><b>Detection</b>: Signature verification fails for tampered logs</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8305"></a>
4. Denial of Service via Audit Flooding</h2>
<p><b>Attack</b>: High-volume invalid inputs to overwhelm logging</p>
<ul>
<li><b>Mitigation</b>: Rate limiting and telemetry coalescing</li>
<li><b>Residual Risk</b>: LOW (queue bounds prevent memory exhaustion)</li>
<li><b>Recovery</b>: Automatic rate limiting and queue management</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8306"></a>
5. Information Disclosure via Logs</h2>
<p><b>Attack</b>: Extracting sensitive information from audit logs</p>
<ul>
<li><b>Mitigation</b>: No key material or sensitive data in logs</li>
<li><b>Residual Risk</b>: VERY LOW (only operational data logged)</li>
<li><b>Verification</b>: Manual log review confirms no secrets exposed</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md8307"></a>
Compliance Assessment</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8308"></a>
NIST Cybersecurity Framework Alignment</h2>
<p><b>Identify</b>: ✅ Security requirements clearly defined in FR-001 through FR-008 <b>Protect</b>: ✅ Access controls and encryption for key storage <b>Detect</b>: ✅ Comprehensive audit logging for security events <b>Respond</b>: ✅ Immediate rejection and logging of unauthorized access <b>Recover</b>: ✅ System continues operation after security events</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8309"></a>
Best Practices Compliance</h2>
<ol type="1">
<li><b>Cryptographic Standards</b><ul>
<li>✅ HMAC-SHA256 (FIPS 140-2 approved algorithm)</li>
<li>✅ Proper key length validation (256-bit minimum)</li>
<li>✅ Secure random key generation (external to device)</li>
</ul>
</li>
<li><b>Access Control</b><ul>
<li>✅ Principle of least privilege (single authorized companion)</li>
<li>✅ Explicit deny by default (whitelist approach)</li>
<li>✅ Access attempt logging</li>
</ul>
</li>
<li><b>Audit and Logging</b><ul>
<li>✅ Comprehensive audit trail</li>
<li>✅ Non-repudiation through signatures</li>
<li>✅ Structured log format for analysis</li>
</ul>
</li>
</ol>
<h1 class="doxsection"><a class="anchor" id="autotoc_md8310"></a>
Vulnerability Assessment</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8311"></a>
High-Risk Vulnerabilities: <b>NONE IDENTIFIED</b></h2>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8312"></a>
Medium-Risk Vulnerabilities: <b>NONE IDENTIFIED</b></h2>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8313"></a>
Low-Risk Observations</h2>
<ol type="1">
<li><b>Key Rotation Not Implemented</b><ul>
<li><b>Risk</b>: Key compromise impact increased over time</li>
<li><b>Mitigation</b>: Manual key updates possible via CLI</li>
<li><b>Priority</b>: LOW (acceptable for mission-specific keys)</li>
</ul>
</li>
<li><b>No Key Strength Validation</b><ul>
<li><b>Risk</b>: Weak keys could be stored</li>
<li><b>Mitigation</b>: External key generation responsibility</li>
<li><b>Priority</b>: LOW (operator education sufficient)</li>
</ul>
</li>
<li><b>Limited Brute Force Protection</b><ul>
<li><b>Risk</b>: Repeated key access attempts not rate-limited</li>
<li><b>Mitigation</b>: Physical access required for effective attack</li>
<li><b>Priority</b>: VERY LOW (hardware security sufficient)</li>
</ul>
</li>
</ol>
<h1 class="doxsection"><a class="anchor" id="autotoc_md8314"></a>
Security Test Results</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8315"></a>
Penetration Testing Scenarios</h2>
<ol type="1">
<li><p class="startli"><b>Invalid Key Access Attempts</b></p>
<div class="fragment"><div class="line">Test: hmac get &quot;wrong_label&quot; </div>
<div class="line">Result: ✅ Properly rejected with ESP_ERR_NOT_FOUND</div>
</div><!-- fragment --></li>
<li><p class="startli"><b>Unauthorized Companion Commands</b></p>
<div class="fragment"><div class="line">Test: SCP command from Session:999 (not whitelisted)</div>
<div class="line">Result: ✅ Rejected and logged as &quot;unauthorized_source&quot;</div>
</div><!-- fragment --></li>
<li><p class="startli"><b>Log Tampering Detection</b></p>
<div class="fragment"><div class="line">Test: Modify exported NDJSON log file</div>
<div class="line">Result: ✅ HMAC verification fails, tamper detected</div>
</div><!-- fragment --></li>
<li><p class="startli"><b>Audit Log Injection</b></p>
<div class="fragment"><div class="line">Test: Send commands with special characters/JSON</div>
<div class="line">Result: ✅ Properly sanitized, no log corruption</div>
</div><!-- fragment --></li>
</ol>
<h1 class="doxsection"><a class="anchor" id="autotoc_md8316"></a>
Security Recommendations</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8317"></a>
Immediate (Critical): <b>NONE REQUIRED</b></h2>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8318"></a>
Short-term (Enhancements)</h2>
<ol type="1">
<li><b>Enable Flash Encryption in Production</b><ul>
<li>Add flash encryption configuration to production builds</li>
<li>Enhances key storage security against physical attacks</li>
</ul>
</li>
<li><b>Add Key Generation Guidance</b><ul>
<li>Document secure key generation practices</li>
<li>Provide recommended key entropy requirements</li>
</ul>
</li>
</ol>
<h2 class="doxsection"><a class="anchor" id="autotoc_md8319"></a>
Long-term (Future Versions)</h2>
<ol type="1">
<li><b>Implement Key Rotation</b><ul>
<li>Automatic key rotation for extended missions</li>
<li>Backward compatibility for log verification</li>
</ul>
</li>
<li><b>Enhanced Access Logging</b><ul>
<li>Log all key access attempts (success and failure)</li>
<li>Add brute force detection capabilities</li>
</ul>
</li>
<li><b>Certificate-Based Authentication</b><ul>
<li>PKI infrastructure for companion device authentication</li>
<li>Stronger identity verification than shared keys</li>
</ul>
</li>
</ol>
<h1 class="doxsection"><a class="anchor" id="autotoc_md8320"></a>
Conclusion</h1>
<p>The HMAC key handling and audit logging implementation demonstrates strong security practices appropriate for the threat model and operational requirements. No critical vulnerabilities were identified, and the system provides robust protection against common attack vectors.</p>
<p><b>Security Approval</b>: ✅ <b>APPROVED FOR DEPLOYMENT</b></p>
<p>The implementation meets security requirements for companion mediation and mission logging with appropriate safeguards for key management and audit trail integrity. The identified low-risk observations are acceptable within the current threat model and can be addressed in future versions as operational requirements evolve.</p>
<p><b>Key Security Strengths</b>:</p>
<ul>
<li>Hardware-backed key storage</li>
<li>Comprehensive audit logging <br  />
</li>
<li>Proper input validation and sanitization</li>
<li>Strong cryptographic primitives (HMAC-SHA256)</li>
<li>Immediate unauthorized access detection and response</li>
</ul>
<p><b>Risk Assessment</b>: <b>LOW</b> overall security risk for intended operational environment. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on <span class="timestamp"></span> for ACP - Autonomous Command Protocol by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.15.0 </li>
  </ul>
</div>
</body>
</html>
