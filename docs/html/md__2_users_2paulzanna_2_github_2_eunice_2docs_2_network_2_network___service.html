<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.15.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ACP - Autonomous Command Protocol: Network Service Review — audit of &lt;tt&gt;network/src/network_tools.py&lt;/tt&gt;</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ACP - Autonomous Command Protocol<span id="projectnumber">&#160;v0.3.0</span>
   </div>
   <div id="projectbrief">Portable C99 framing library with COBS, CRC16, and HMAC-SHA256 authentication</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.15.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('md__2_users_2paulzanna_2_github_2_eunice_2docs_2_network_2_network___service.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Network Service Review — audit of <span class="tt">network/src/network_tools.py</span> </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md2046"></a></p>
<p>Purpose: a concise, actionable audit of the <span class="tt">network</span> service helpers, the public functions available, MCP tools they call, capabilities, security/resource correctness risks, and prioritized fixes / next steps.</p>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md2048"></a>
Quick plan</h1>
<ul>
<li>Read the provided <span class="tt">network/src/network_tools.py</span> and extract all public helpers and their intent.</li>
<li>Enumerate MCP tools used or expected by the module.</li>
<li>Surface implementation status, security issues, and prioritized fixes.</li>
<li>Recommend next steps and an actionable low-risk change to make the file runnable and testable.</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md2049"></a>
Checklist (requirements)</h1>
<ul class="check">
<li class="checked">Enumerate public/important functions and their capabilities.</li>
</ul>
<ul class="check">
<li class="checked">Describe inputs, outputs and purpose for each function.</li>
</ul>
<ul class="check">
<li class="checked">Identify MCP tool calls and describe their role.</li>
</ul>
<ul class="check">
<li class="checked">Surface security, resource, and correctness issues.</li>
</ul>
<ul class="check">
<li class="checked">Provide prioritized fixes, tests, and follow-ups.</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md2050"></a>
High-level summary</h1>
<p>This module is a comprehensive networking helper for the MCP server. It provides:</p>
<ul>
<li>Literature search adapters (PubMed / OpenAlex / CORE).</li>
<li>Full-text location, fetching and PDF parsing using optional PyMuPDF.</li>
<li>Generic HTTP utilities and URL content extraction.</li>
<li>DNS resolution and basic connectivity checks.</li>
<li>AI chat wrapper (provider-agnostic placeholder) and an extraction v2 orchestration pipeline.</li>
</ul>
<p>Design strengths:</p>
<ul>
<li>Uses small Pydantic response envelopes for observability.</li>
<li>Explicit safe-url checks and a PubMed rate-limiter are present.</li>
<li>Well-structured orchestration and normalization logic for multi-source literature search.</li>
</ul>
<p>Main concern: Many functions are partially implemented — the file contains many placeholder/empty branches and missing imports. As-is the module is not runnable and will raise errors.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md2051"></a>
Top-level artifacts</h1>
<ul>
<li>Schemas (Pydantic): <span class="tt">ResponseEnvelope</span>, <span class="tt">SearchHit</span>, <span class="tt">FullTextMeta</span>, <span class="tt">ParsedSection</span>.</li>
<li>Security/config constants: <span class="tt">ALLOWED_SCHEMES</span>, <span class="tt">MAX_BYTES</span>, <span class="tt">MAX_REDIRECTS</span>, <span class="tt">ALLOWED_MIME</span>, PubMed defaults, base URLs.</li>
<li>Helper constructors: <span class="tt">_mk_ids()</span>, <span class="tt">ok()</span>, <span class="tt">err()</span> for standardized envelopes.</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md2052"></a>
Public / Important functions (summary)</h1>
<p>For each item: name — purpose — inputs/outputs — status</p>
<ol type="1">
<li><span class="tt">_assert_safe_url(url, allow_schemes=...)</span></li>
</ol>
<ul>
<li>Purpose: Validate scheme, host, DNS resolution and block private/multicast/loopback addresses.</li>
<li>Inputs: URL string</li>
<li>Outputs: raises <span class="tt">NetworkToolsError</span> on failures; None on success</li>
<li>Status: Mostly implemented. Ensure required imports exist and timeouts are enforced on DNS lookups.</li>
</ul>
<ol type="1">
<li><span class="tt">_bounded_fetch(session, url, timeout=60)</span></li>
</ol>
<ul>
<li>Purpose: Perform GET with limited redirects, streaming read with <span class="tt">MAX_BYTES</span> cap; return (bytes, content_type)</li>
<li>Status: Partial — redirect handling loop and MAX_BYTES enforcement contain empty branches and must be completed.</li>
</ul>
<ol type="1">
<li><span class="tt">pubmed_slot()</span> (async context manager)</li>
</ol>
<ul>
<li>Purpose: Semaphore-based rate-limiter for NCBI requests.</li>
<li>Status: Implemented.</li>
</ul>
<ol type="1">
<li><span class="tt">literature_full_text_locate(record)</span></li>
</ol>
<ul>
<li>Purpose: Heuristic PDF URL resolution (record.url, DOI/doi.org fallback)</li>
<li>Output: <span class="tt">{candidate_urls, chosen, success}</span></li>
<li>Status: Implemented.</li>
</ul>
<ol type="1">
<li><span class="tt">literature_full_text_fetch(url, timeout=60)</span></li>
</ol>
<ul>
<li>Purpose: Download binary content (expects PDF), write to a temp file, return metadata (sha256, size, mime, storage_path)</li>
<li>Status: Partial — large bodies of logic are placeholders. Needs robust MIME detection, allowed-mime checks, temp-file atomic write and cleanup.</li>
</ul>
<ol type="1">
<li><span class="tt">_extract_pdf_sections(doc)</span> and <span class="tt">literature_full_text_parse(data, mime)</span></li>
</ol>
<ul>
<li>Purpose: Extract structured sections from PDFs using PyMuPDF (optional <span class="tt">fitz</span>) and handle encrypted PDFs.</li>
<li>Status: Partial — extraction algorithm skeleton present but implementation incomplete.</li>
</ul>
<ol type="1">
<li><span class="tt">literature_full_text_pipeline(record, database_service_url=None)</span></li>
</ol>
<ul>
<li>Purpose: End-to-end locate -&gt; fetch -&gt; parse -&gt; persist via MCP streaming calls (<span class="tt">full_text_upsert</span>, <span class="tt">parsed_sections_bulk_insert</span>).</li>
<li>Status: Partial — persistence and result extraction code contains placeholders; temp-file cleanup and consistent error mapping need work.</li>
</ul>
<ol type="1">
<li><span class="tt">_persist_evidence_graph(session, db_url, record, payload, spans)</span></li>
</ol>
<ul>
<li>Purpose: Upsert source/variants/anchors/claims into Evidence Graph using MCP tools.</li>
<li>Status: Mostly scaffolded; some claim/anchor linking code incomplete.</li>
</ul>
<ol type="1">
<li><span class="tt">google_web_search(query, page, num_results, api_key, search_engine_id)</span></li>
</ol>
<ul>
<li>Purpose: Google Custom Search API wrapper.</li>
<li>Status: Partial — parameter handling present; request/response parsing missing.</li>
</ul>
<ol type="1">
<li><span class="tt">ai_model_chat(messages, model, provider, ...)</span></li>
</ol>
<ul>
<li>Purpose: Generic AI provider wrapper (OpenAI / Anthropic / XAI).</li>
<li>Status: Missing — implementation needed per provider.</li>
</ul>
<ol type="1">
<li><span class="tt">literature_search(query, database, max_results, api_key)</span></li>
</ol>
<ul>
<li>Purpose: Single-source search wrapper (pubmed/core/openalex)</li>
<li>Status: Missing — implementation needed.</li>
</ul>
<ol type="1">
<li><span class="tt">_fetch_pubmed_details</span>, <span class="tt">_search_pubmed</span>, <span class="tt">_search_core</span>, <span class="tt">_search_openalex</span></li>
</ol>
<ul>
<li>Purpose: Source-specific search and detail fetchers with paging and polite spacing for PubMed.</li>
<li>Status: Partially implemented; network loops and JSON parsing incomplete.</li>
</ul>
<ol type="1">
<li><span class="tt">multi_source_literature_search(query, sources, ...)</span></li>
</ol>
<ul>
<li>Purpose: Orchestrate parallel searches, normalize, deduplicate, rank (RRF/BM25/optional embedding), persist records and enqueue screening items.</li>
<li>Status: Well-designed pipeline and ranking code, but many network/persistence pieces contain TODOs/placeholders.</li>
</ul>
<ol type="1">
<li><span class="tt">http_request(url, method, headers, params, json_data, timeout)</span></li>
</ol>
<ul>
<li>Purpose: Generic retryable HTTP helper wrapped with tenacity.</li>
<li>Status: Missing — vital for many higher-level functions.</li>
</ul>
<ol type="1">
<li><span class="tt">extract_url_content(url, ...)</span>, <span class="tt">dns_resolve(hostname, record_type)</span>, <span class="tt">network_connectivity_check(host, port)</span></li>
</ol>
<ul>
<li>Purpose: Page extraction, DNS queries, TCP connectivity checks.</li>
<li>Status: Partial — skeletons present but implementations are incomplete.</li>
</ul>
<ol type="1">
<li>MCP helpers: <span class="tt">_mcp_stream_call</span>, <span class="tt">_maybe_json_load</span>, <span class="tt">_db_query_parsed_sections</span>, <span class="tt">_db_query_literature_record</span>, <span class="tt">_db_upsert_extraction</span></li>
</ol>
<ul>
<li>Purpose: Centralized MCP tool caller that handles direct JSON and SSE streaming responses; DB convenience wrappers.</li>
<li>Status: <span class="tt">_mcp_stream_call</span> has a useful skeleton but SSE parsing and robust error handling should be implemented and tested.</li>
</ul>
<ol type="1">
<li>Extraction v2 orchestration: <span class="tt">_verify_and_enrich_spans</span>, <span class="tt">extraction_v2_process</span>, <span class="tt">extraction_v2_run</span></li>
</ol>
<ul>
<li>Purpose: Validate spans, run chunker/orchestrator, persist extraction results.</li>
<li>Status: High-level flow present but many integration steps are placeholders.</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md2053"></a>
MCP tool names observed (expected by this module)</h1>
<ul>
<li><span class="tt">tools/call</span> (generic JSON-RPC wrapper used by <span class="tt">_mcp_stream_call</span>)</li>
<li><span class="tt">full_text_upsert</span></li>
<li><span class="tt">parsed_sections_bulk_insert</span></li>
<li><span class="tt">evidence_upsert_source</span></li>
<li><span class="tt">evidence_add_variant</span></li>
<li><span class="tt">evidence_add_anchor</span></li>
<li><span class="tt">evidence_upsert_claim</span></li>
<li><span class="tt">db.query</span></li>
<li><span class="tt">extraction_v2_upsert</span></li>
<li><span class="tt">extraction_v2_start</span> (referenced by docstrings)</li>
<li><span class="tt">db.mutate</span> (used via <span class="tt">POST</span> to <span class="tt">/tools/db.mutate</span> path)</li>
</ul>
<p>Confirm the real MCP tool names in the DB/fastmcp service before relying on them.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md2054"></a>
Key issues &amp; risks (priority)</h1>
<ol type="1">
<li>Missing imports and undefined names (e.g. <span class="tt">os</span>, <span class="tt">uuid</span>, <span class="tt">socket</span>, <span class="tt">ipaddress</span>, <span class="tt">aiohttp</span>, <span class="tt">asyncio</span>, <span class="tt">ssl</span>, <span class="tt">certifi</span>, <span class="tt">tempfile</span>, <span class="tt">mimetypes</span>, <span class="tt">hashlib</span>, <span class="tt">json</span>, <span class="tt">re</span>, <span class="tt">math</span>, <span class="tt">logging</span>, <span class="tt">fitz</span>, <span class="tt">mimetypes</span>) — add and validate.</li>
<li>Numerous incomplete code branches — many <span class="tt">if</span> / <span class="tt">try</span> blocks are empty; the module will not run.</li>
<li>Inconsistent return shapes (<span class="tt">status</span> vs <span class="tt">success</span> vs <span class="tt">ResponseEnvelope</span>); standardize a single external contract.</li>
<li>Temporary file lifecycle and cleanup are inconsistent; ensure secure atomic writes and deletion.</li>
<li>MIME whitelist enforcement must be robust to avoid saving HTML or malicious content.</li>
<li>Redirect handling needs to validate <span class="tt">Location</span> and allow relative redirects per RFC; check for redirect loops.</li>
<li>TCP/HTTP connector limits and concurrency caps are not set — add connector <span class="tt">limit</span> to avoid resource exhaustion.</li>
<li>SSE parsing in <span class="tt">_mcp_stream_call</span> is fragile; implement fully compliant SSE parsing and test it.</li>
<li>Credentials (API keys) and env var usage should provide clear errors when required keys are missing.</li>
<li>DNS and IP checks should use timeouts and consider IPv6/mapped addresses safely.</li>
</ol>
<h1 class="doxsection"><a class="anchor" id="autotoc_md2055"></a>
Prioritized fixes (concrete)</h1>
<ol type="1">
<li>Add missing imports and expose clear NotImplementedError or explicit failures where logic is intentionally unimplemented. This will make failures fast and debuggable. (Quick win)</li>
<li>Implement <span class="tt">_bounded_fetch</span> fully: redirect loop, <span class="tt">_assert_safe_url</span> on redirects, MAX_BYTES enforcement, MIME sniffing. (High priority)</li>
<li>Implement <span class="tt">literature_full_text_fetch</span> end-to-end including secure temp file write and deterministic cleanup. (High)</li>
<li>Implement robust SSE parsing inside <span class="tt">_mcp_stream_call</span> and add unit tests that simulate direct JSON and streamed SSE. (High)</li>
<li>Implement <span class="tt">http_request</span> as a common, tested wrapper used by higher-level functions. (High)</li>
<li>Standardize and document the external envelope format (use <span class="tt">ResponseEnvelope</span>) and normalize all public helpers to return that. (Medium)</li>
<li>Add unit tests for: safe-url, bounded fetch (max bytes), full-text pipeline (happy path + encrypted PDF), SSE parsing, multi-source search dedup logic (mocked APIs). (High)</li>
<li>Add CI checks: flake8/mypy, pytest, and a small smoke test that runs with network mocked. (Medium)</li>
</ol>
<h1 class="doxsection"><a class="anchor" id="autotoc_md2056"></a>
Immediate, low-risk suggestions I can implement now</h1>
<ul>
<li>Add missing imports and a minimal fail-fast replacement in empty branches so the file loads (this surfaces further errors).</li>
<li>Add a small <span class="tt">docs/Network/Network_Service.md</span> (this file) explaining the MCP tools required and env variables expected.</li>
</ul>
<p>If you want me to continue: I can immediately implement the low-risk import/fail-fast changes and run tests to reveal the next set of issues.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md2057"></a>
Recommended next steps and roadmap</h1>
<ol type="1">
<li>Apply the quick fail-fast changes and run linter/typecheck to collect errors.</li>
<li>Implement core primitives in order: <span class="tt">_bounded_fetch</span>, <span class="tt">http_request</span>, <span class="tt">_mcp_stream_call</span> SSE parsing.</li>
<li>Implement <span class="tt">literature_full_text_fetch</span> and <span class="tt">literature_full_text_parse</span> including encrypted-PDF handling.</li>
<li>Add unit tests and CI to guard regressions.</li>
<li>Gradually complete <span class="tt">multi_source_literature_search</span> network/persistence steps and add integration tests (mocked network + MCP).</li>
</ol>
<h1 class="doxsection"><a class="anchor" id="autotoc_md2058"></a>
Environment &amp; external dependencies required</h1>
<ul>
<li><span class="tt">aiohttp</span>, <span class="tt">tenacity</span>, <span class="tt">pydantic</span>, <span class="tt">certifi</span>, <span class="tt">PyMuPDF</span> (optional), <span class="tt">dnspython</span> (optional but recommended), <span class="tt">pytest-asyncio</span> for testing.</li>
<li>Environment variables used by the module (examples):<ul>
<li><span class="tt">MAX_BYTES</span>, <span class="tt">MAX_REDIRECTS</span>, <span class="tt">ALLOWED_MIME</span>, <span class="tt">HTTP_POST_MAX_BYTES</span></li>
<li><span class="tt">NCBI_RPS</span>, <span class="tt">NCBI_TOOL</span>, <span class="tt">NCBI_EMAIL</span></li>
<li><span class="tt">PUBMED_BASE</span>, <span class="tt">PUBMED_SUMMARY_BASE</span>, <span class="tt">OPENALEX_BASE</span></li>
<li><span class="tt">DATABASE_SERVICE_URL</span>, <span class="tt">GOOGLE_API_KEY</span>, <span class="tt">GOOGLE_SEARCH_ENGINE_ID</span>, <span class="tt">CORE_API_KEY</span></li>
</ul>
</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md2059"></a>
Requirements coverage</h1>
<ul>
<li>Enumerate functions, MCP calls, capabilities: Done</li>
<li>Identify MCP tools used/exposed: Done</li>
<li>Surface security/resource/correctness issues: Done</li>
<li>Provide prioritized fixes, tests, follow-ups: Done</li>
</ul>
<hr  />
 </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on <span class="timestamp"></span> for ACP - Autonomous Command Protocol by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.15.0 </li>
  </ul>
</div>
</body>
</html>
