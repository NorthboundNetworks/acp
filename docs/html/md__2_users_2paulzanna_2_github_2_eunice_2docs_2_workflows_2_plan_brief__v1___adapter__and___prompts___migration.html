<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.15.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ACP - Autonomous Command Protocol: Eunice v0.5.1 — PlanBrief v1 Adapter &amp; External Prompts Migration (Finalised PlanBrief-Only Model)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ACP - Autonomous Command Protocol<span id="projectnumber">&#160;v0.3.0</span>
   </div>
   <div id="projectbrief">Portable C99 framing library with COBS, CRC16, and HMAC-SHA256 authentication</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.15.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('md__2_users_2paulzanna_2_github_2_eunice_2docs_2_workflows_2_plan_brief__v1___adapter__and___prompts___migration.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Eunice v0.5.1 — PlanBrief v1 Adapter &amp; External Prompts Migration (Finalised PlanBrief-Only Model) </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md2252"></a></p>
<p><b>Owner:</b> Research Manager / API Gateway <br  />
 <b>Date:</b> 10-08-2025 (AEST) <br  />
 <b>Goal:</b> Restore and lock the original research-plan JSON format ("PlanBrief v1") as the <em>only</em> generation + import/export shape, and move all prompts back to external JSON templates (no embedded prompts in code). All legacy interim schemas (e.g. the historical <span class="tt">create_research_plan.schema.json</span>) are deprecated and no longer loaded.</p>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md2254"></a>
1) Summary of Changes (Current State)</h1>
<ul>
<li>PlanBrief v1 is the <b>only</b> accepted / produced plan JSON shape.</li>
<li>Bidirectional adapter: PlanBrief v1 ↔ internal canonical plan representation.</li>
<li>All LLM prompts externalised (JSON files) and loaded via a hot‑reload capable registry; no embedded strings remain.</li>
<li>Gateway API supports import/export in PlanBrief v1 without code modifications.</li>
<li>Unified validation path: irrespective of per‑prompt metadata, generation is always validated against <span class="tt">plan_brief_v1.schema.json</span>.</li>
<li>Test coverage: schema validation, adapter round‑trip, prompt registry loading, generation + normalization, repair path (basic), and E2E.</li>
<li>Legacy schema file <span class="tt">research-manager/prompts/create_research_plan.schema.json</span> retained only as a stub containing a deprecation marker (tooling limitation prevented physical deletion) — not referenced at runtime.</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md2256"></a>
2) File/Folder Conventions</h1>
<div class="fragment"><div class="line">research-manager/</div>
<div class="line">└── prompts/                          # External prompt configs (JSON)</div>
<div class="line">    ├── create_research_plan.json</div>
<div class="line">    ├── improve_research_plan.json</div>
<div class="line">    └── ...</div>
<div class="line">api-gateway/</div>
<div class="line">└── config/</div>
<div class="line">    └── plan_brief_v1.schema.json     # JSON schema for PlanBrief v1</div>
</div><!-- fragment --><p><b>Environment variables</b> (read by API Gateway and Research Manager Workers):</p>
<ul>
<li><span class="tt">PROMPTS_DIR</span> (default: <span class="tt">research-manager/prompts</span>)</li>
<li><span class="tt">PROMPTS_HOTRELOAD</span> (default: <span class="tt">true</span>)</li>
<li><span class="tt">PROMPTS_CACHE_TTL_SECONDS</span> (default: <span class="tt">60</span>)</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md2258"></a>
3) PlanBrief v1 JSON Schema (Authoritative &amp; Sole)</h1>
<p>Save as <span class="tt">api-gateway/config/plan_brief_v1.schema.json</span>:</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;$id&quot;: &quot;plan_brief_v1.schema.json&quot;,</div>
<div class="line">  &quot;type&quot;: &quot;object&quot;,</div>
<div class="line">  &quot;required&quot;: [&quot;sources&quot;,&quot;outcomes&quot;,&quot;timeline&quot;,&quot;key_areas&quot;,&quot;questions&quot;,&quot;objectives&quot;],</div>
<div class="line">  &quot;properties&quot;: {</div>
<div class="line">    &quot;sources&quot;: {&quot;type&quot;: &quot;array&quot;, &quot;items&quot;: {&quot;type&quot;: &quot;string&quot;}},</div>
<div class="line">    &quot;outcomes&quot;: {&quot;type&quot;: &quot;array&quot;, &quot;items&quot;: {&quot;type&quot;: &quot;string&quot;}},</div>
<div class="line">    &quot;timeline&quot;: {</div>
<div class="line">      &quot;type&quot;: &quot;object&quot;,</div>
<div class="line">      &quot;required&quot;: [&quot;phases&quot;,&quot;total_days&quot;],</div>
<div class="line">      &quot;properties&quot;: {</div>
<div class="line">        &quot;phases&quot;: {</div>
<div class="line">          &quot;type&quot;: &quot;object&quot;,</div>
<div class="line">          &quot;additionalProperties&quot;: {&quot;type&quot;: &quot;integer&quot;}</div>
<div class="line">        },</div>
<div class="line">        &quot;total_days&quot;: {&quot;type&quot;: &quot;integer&quot;}</div>
<div class="line">      },</div>
<div class="line">      &quot;additionalProperties&quot;: false</div>
<div class="line">    },</div>
<div class="line">    &quot;key_areas&quot;: {&quot;type&quot;: &quot;array&quot;, &quot;items&quot;: {&quot;type&quot;: &quot;string&quot;}},</div>
<div class="line">    &quot;questions&quot;: {&quot;type&quot;: &quot;array&quot;, &quot;items&quot;: {&quot;type&quot;: &quot;string&quot;}},</div>
<div class="line">    &quot;objectives&quot;: {&quot;type&quot;: &quot;array&quot;, &quot;items&quot;: {&quot;type&quot;: &quot;string&quot;}}</div>
<div class="line">  },</div>
<div class="line">  &quot;additionalProperties&quot;: false</div>
<div class="line">}</div>
</div><!-- fragment --><hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md2260"></a>
4) Adapter (PlanBrief v1 ↔ Internal Canonical)</h1>
<p><b>Purpose:</b> Keep your existing DB schema intact while allowing PlanBrief v1 to be the user‑facing format.</p>
<div class="fragment"><div class="line"><span class="comment"># api-gateway/src/plan_adapter.py</span></div>
<div class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass, asdict</div>
<div class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Dict, Any, List</div>
<div class="line"><span class="keyword">import</span> json</div>
<div class="line"><span class="keyword">import</span> textwrap</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">@dataclass</span></div>
<div class="line"><span class="keyword">class </span>PlanBriefV1:</div>
<div class="line">    sources: List[str]</div>
<div class="line">    outcomes: List[str]</div>
<div class="line">    timeline: Dict[str, Any]   <span class="comment"># {&quot;phases&quot;: {...}, &quot;total_days&quot;: int}</span></div>
<div class="line">    key_areas: List[str]</div>
<div class="line">    questions: List[str]</div>
<div class="line">    objectives: List[str]</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">@dataclass</span></div>
<div class="line"><span class="keyword">class </span>CanonicalPlan:</div>
<div class="line">    name: str</div>
<div class="line">    methodology_md: str</div>
<div class="line">    timeline_days: int</div>
<div class="line">    metadata: Dict[str, Any]</div>
<div class="line"> </div>
<div class="line">MD_TEMPLATE = \<span class="stringliteral">&quot;\&quot;\&quot;### Plan Overview (PlanBrief v1)</span></div>
<div class="line"><span class="stringliteral">**Sources:** {sources}</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">**Outcomes:**</span></div>
<div class="line"><span class="stringliteral">{outcomes_md}</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">**Timeline**</span></div>
<div class="line"><span class="stringliteral">- Total days: {total_days}</span></div>
<div class="line"><span class="stringliteral">- Phases:</span></div>
<div class="line"><span class="stringliteral">{phases_md}</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">**Key Areas:**</span></div>
<div class="line"><span class="stringliteral">{key_areas_md}</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">**Research Questions:**</span></div>
<div class="line"><span class="stringliteral">{questions_md}</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">**Objectives:**</span></div>
<div class="line"><span class="stringliteral">{objectives_md}</span></div>
<div class="line"><span class="stringliteral">\&quot;\&quot;\&quot;</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral"></span><span class="keyword">def </span>_bullets(items: List[str], indent=0) -&gt; str:</div>
<div class="line">    pad = <span class="stringliteral">&quot; &quot;</span> * indent</div>
<div class="line">    <span class="keywordflow">return</span> <span class="stringliteral">&quot;\\n&quot;</span>.join(f<span class="stringliteral">&quot;{pad}- {x}&quot;</span> <span class="keywordflow">for</span> x <span class="keywordflow">in</span> items)</div>
<div class="line"> </div>
<div class="line"><span class="keyword">def </span>_pretty_phases(phases: Dict[str,int], indent=2) -&gt; str:</div>
<div class="line">    pad = <span class="stringliteral">&quot; &quot;</span> * indent</div>
<div class="line">    <span class="keywordflow">return</span> <span class="stringliteral">&quot;\\n&quot;</span>.join(f<span class="stringliteral">&quot;{pad}- {k}: {v} day(s)&quot;</span> <span class="keywordflow">for</span> k,v <span class="keywordflow">in</span> phases.items())</div>
<div class="line"> </div>
<div class="line"><span class="keyword">def </span>brief_to_canonical(brief: PlanBriefV1, *, name: str) -&gt; CanonicalPlan:</div>
<div class="line">    methodology_md = MD_TEMPLATE.format(</div>
<div class="line">        sources=<span class="stringliteral">&quot;, &quot;</span>.join(brief.sources),</div>
<div class="line">        outcomes_md=_bullets(brief.outcomes, indent=0),</div>
<div class="line">        total_days=brief.timeline[<span class="stringliteral">&quot;total_days&quot;</span>],</div>
<div class="line">        phases_md=_pretty_phases(brief.timeline[<span class="stringliteral">&quot;phases&quot;</span>], indent=2),</div>
<div class="line">        key_areas_md=_bullets(brief.key_areas, indent=0),</div>
<div class="line">        questions_md=_bullets(brief.questions, indent=0),</div>
<div class="line">        objectives_md=_bullets(brief.objectives, indent=0),</div>
<div class="line">    )</div>
<div class="line">    <span class="keywordflow">return</span> CanonicalPlan(</div>
<div class="line">        name=name,</div>
<div class="line">        methodology_md=methodology_md,</div>
<div class="line">        timeline_days=int(brief.timeline[<span class="stringliteral">&quot;total_days&quot;</span>]),</div>
<div class="line">        metadata={<span class="stringliteral">&quot;plan_brief_v1&quot;</span>: asdict(brief)}</div>
<div class="line">    )</div>
<div class="line"> </div>
<div class="line"><span class="keyword">def </span>canonical_to_brief(plan: CanonicalPlan) -&gt; PlanBriefV1:</div>
<div class="line">    raw = plan.metadata.get(<span class="stringliteral">&quot;plan_brief_v1&quot;</span>)</div>
<div class="line">    <span class="keywordflow">if</span> <span class="keywordflow">not</span> raw:</div>
<div class="line">        <span class="keywordflow">raise</span> ValueError(<span class="stringliteral">&quot;No PlanBrief v1 found in metadata; cannot export.&quot;</span>)</div>
<div class="line">    <span class="keywordflow">return</span> PlanBriefV1(**raw)</div>
</div><!-- fragment --><p><b>Integration points (API Gateway):</b></p>
<ul>
<li>On <b>create/update</b> with <span class="tt">plan_brief_v1</span> body → validate with schema → <span class="tt">brief_to_canonical()</span> → persist canonical fields + stash the original brief in <span class="tt">metadata.plan_brief_v1</span>.</li>
<li>On <b>GET /plans/{id}?format=plan_brief_v1</b> (legacy: /v2/...) → load canonical → <span class="tt">canonical_to_brief()</span> → return JSON.</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md2262"></a>
5) External Prompt Templates (No Embedded Prompts)</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md2263"></a>
5.1 Prompt JSON schema (lightweight)</h2>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;$id&quot;: &quot;prompt.schema.json&quot;,</div>
<div class="line">  &quot;type&quot;: &quot;object&quot;,</div>
<div class="line">  &quot;required&quot;: [&quot;id&quot;,&quot;description&quot;,&quot;model&quot;,&quot;system_prompt&quot;,&quot;user_prompt_template&quot;],</div>
<div class="line">  &quot;properties&quot;: {</div>
<div class="line">    &quot;id&quot;: {&quot;type&quot;: &quot;string&quot;},</div>
<div class="line">    &quot;description&quot;: {&quot;type&quot;: &quot;string&quot;},</div>
<div class="line">    &quot;agent_type&quot;: {&quot;type&quot;: &quot;string&quot;},</div>
<div class="line">    &quot;model&quot;: {&quot;type&quot;: &quot;string&quot;},</div>
<div class="line">    &quot;system_prompt&quot;: {&quot;type&quot;: &quot;string&quot;},</div>
<div class="line">    &quot;user_prompt_template&quot;: {&quot;type&quot;: &quot;string&quot;},</div>
<div class="line">    &quot;tools&quot;: {&quot;type&quot;: &quot;array&quot;, &quot;items&quot;: {&quot;type&quot;: &quot;object&quot;}},</div>
<div class="line">    &quot;tool_choice&quot;: {&quot;type&quot;: &quot;string&quot;},</div>
<div class="line">    &quot;max_tokens&quot;: {&quot;type&quot;: &quot;integer&quot;},</div>
<div class="line">    &quot;temperature&quot;: {&quot;type&quot;: &quot;number&quot;},</div>
<div class="line">  &quot;metadata&quot;: {&quot;type&quot;: &quot;object&quot;}</div>
<div class="line">  },</div>
<div class="line">  &quot;additionalProperties&quot;: true</div>
<div class="line">}</div>
</div><!-- fragment --><blockquote class="doxtable">
<p>NOTE: Earlier drafts referenced a per‑prompt <span class="tt">output_contract_schema</span> allowing multiple plan schemas. This has been superseded. Even if a prompt JSON retains such a key, the runtime forcibly overrides to the single authoritative <span class="tt">plan_brief_v1.schema.json</span> for validation. Remove obsolete keys gradually; they are ignored. </p>
</blockquote>
<h2 class="doxsection"><a class="anchor" id="autotoc_md2264"></a>
5.2 Example prompt (<span class="tt">research-manager/prompts/create_research_plan.json</span>)</h2>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;id&quot;: &quot;create_research_plan&quot;,</div>
<div class="line">  &quot;description&quot;: &quot;Generate a detailed research plan in PlanBrief v1 JSON.&quot;,</div>
<div class="line">  &quot;agent_type&quot;: &quot;ai_service&quot;,</div>
<div class="line">  &quot;model&quot;: &quot;grok-3-mini&quot;,</div>
<div class="line">  &quot;system_prompt&quot;: &quot;You are a research planning assistant. Output MUST be valid PlanBrief v1 JSON and nothing else.&quot;,</div>
<div class="line">  &quot;user_prompt_template&quot;: &quot;Create a research plan for the topic below. Validate output against the PlanBrief v1 shape.\\n\\nTitle: {topic_title}\\nDescription: {topic_description}\\nScope: Comprehensive\\n\\nReturn ONLY JSON.&quot;,</div>
<div class="line">  &quot;tool_choice&quot;: &quot;auto&quot;,</div>
<div class="line">  &quot;max_tokens&quot;: 3000,</div>
<div class="line">  &quot;temperature&quot;: 0.4,</div>
<div class="line">  &quot;metadata&quot;: {</div>
<div class="line">    &quot;version&quot;: &quot;2025-08-10&quot;</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><blockquote class="doxtable">
<p>Deprecation: The historical <span class="tt">create_research_plan.schema.json</span> file has been replaced with a JSON object <span class="tt">{ "deprecated": true, ... }</span> to avoid accidental reuse while tooling deletion constraints are resolved. </p>
</blockquote>
<h2 class="doxsection"><a class="anchor" id="autotoc_md2265"></a>
5.3 Prompt Registry/Loader (hot‑reload capable)</h2>
<div class="fragment"><div class="line"><span class="comment"># research-manager/src/prompt_registry.py</span></div>
<div class="line"><span class="keyword">import</span> json, os, time, threading</div>
<div class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</div>
<div class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Dict, Any, Optional</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>PromptRegistry:</div>
<div class="line">    <span class="keyword">def </span>__init__(self, base_dir: Optional[str] = <span class="keywordtype">None</span>, ttl_seconds: int = 60, hotreload: bool = <span class="keyword">True</span>):</div>
<div class="line">        self.base_dir = Path(base_dir <span class="keywordflow">or</span> os.getenv(<span class="stringliteral">&quot;PROMPTS_DIR&quot;</span>, <span class="stringliteral">&quot;research-manager/prompts&quot;</span>))</div>
<div class="line">        self.ttl = int(os.getenv(<span class="stringliteral">&quot;PROMPTS_CACHE_TTL_SECONDS&quot;</span>, ttl_seconds))</div>
<div class="line">        self.hotreload = os.getenv(<span class="stringliteral">&quot;PROMPTS_HOTRELOAD&quot;</span>, <span class="stringliteral">&quot;true&quot;</span>).lower() == <span class="stringliteral">&quot;true&quot;</span> <span class="keywordflow">if</span> hotreload <span class="keywordflow">else</span> <span class="keyword">False</span></div>
<div class="line">        self._cache: Dict[str, Dict[str, Any]] = {}</div>
<div class="line">        self._mtime: Dict[str, float] = {}</div>
<div class="line">        <span class="keywordflow">if</span> self.hotreload:</div>
<div class="line">            t = threading.Thread(target=self._watch_loop, daemon=<span class="keyword">True</span>)</div>
<div class="line">            t.start()</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">def </span>_watch_loop(self):</div>
<div class="line">        <span class="keywordflow">while</span> <span class="keyword">True</span>:</div>
<div class="line">            time.sleep(self.ttl)</div>
<div class="line">            <span class="keywordflow">for</span> pth <span class="keywordflow">in</span> self.base_dir.glob(<span class="stringliteral">&quot;*.json&quot;</span>):</div>
<div class="line">                m = pth.stat().st_mtime</div>
<div class="line">                <span class="keywordflow">if</span> self._mtime.get(pth.name, 0) &lt; m:</div>
<div class="line">                    self._cache.pop(pth.stem, <span class="keywordtype">None</span>)</div>
<div class="line">                    self._mtime[pth.name] = m</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">def </span>get(self, prompt_id: str) -&gt; Dict[str, Any]:</div>
<div class="line">        file = self.base_dir / f<span class="stringliteral">&quot;{prompt_id}.json&quot;</span></div>
<div class="line">        <span class="keywordflow">if</span> <span class="keywordflow">not</span> file.exists():</div>
<div class="line">            <span class="keywordflow">raise</span> FileNotFoundError(f<span class="stringliteral">&quot;Prompt not found: {file}&quot;</span>)</div>
<div class="line">        m = file.stat().st_mtime</div>
<div class="line">        <span class="keywordflow">if</span> prompt_id <span class="keywordflow">not</span> <span class="keywordflow">in</span> self._cache <span class="keywordflow">or</span> self._mtime.get(file.name, 0) &lt; m:</div>
<div class="line">            <span class="keyword">with</span> file.open(<span class="stringliteral">&quot;r&quot;</span>, encoding=<span class="stringliteral">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</div>
<div class="line">                data = json.load(f)</div>
<div class="line">            <span class="comment"># TODO: validate against prompt.schema.json if desired</span></div>
<div class="line">            self._cache[prompt_id] = data</div>
<div class="line">            self._mtime[file.name] = m</div>
<div class="line">        <span class="keywordflow">return</span> self._cache[prompt_id]</div>
</div><!-- fragment --><p><b>Usage:</b> <span class="tt">registry.get("create_research_plan")</span> → returns dict with <span class="tt">system_prompt</span>, <span class="tt">user_prompt_template</span>, etc.</p>
<p><b>Action (completed):</b> All hard‑coded prompts removed. New prompts added by dropping JSON files into the directory; registry hot‑reload picks them up within TTL.</p>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md2267"></a>
6) API Changes (Implemented)</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md2268"></a>
6.1 Import/Export endpoints</h2>
<ul>
<li><b>Export PlanBrief v1</b><ul>
<li><span class="tt">GET /plans/{plan_id}?format=plan_brief_v1</span> (legacy: /v2/...)</li>
<li><b>200</b> → body is the original PlanBrief v1 JSON (from metadata)</li>
</ul>
</li>
<li><b>Create from PlanBrief v1</b><ul>
<li><span class="tt">POST /topics/{topic_id}/plans?input_format=plan_brief_v1</span> (legacy: /v2/...)</li>
<li>Body: PlanBrief v1 JSON</li>
<li>Flow: validate → <span class="tt">brief_to_canonical()</span> → persist canonical</li>
</ul>
</li>
<li><b>Update from PlanBrief v1</b><ul>
<li><span class="tt">PUT /plans/{plan_id}?input_format=plan_brief_v1</span> (legacy: /v2/...)</li>
<li>Flow: validate → <span class="tt">brief_to_canonical()</span> → merge/update canonical + metadata</li>
</ul>
</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md2269"></a>
6.2 Research Manager uses prompts by ID</h2>
<ul>
<li><span class="tt">POST /topics/{topic_id}/ai-plans</span> (formerly <span class="tt">/v2/...</span>)<ul>
<li>Query params: <span class="tt">prompt_id=create_research_plan</span> (default)</li>
<li>Server loads prompt via <span class="tt">PromptRegistry</span></li>
<li>LLM output must validate against PlanBrief v1 schema before persisting</li>
</ul>
</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md2271"></a>
7) Validation &amp; Tests (Implemented)</h1>
<ul>
<li><b>Schema validation</b>: Validate incoming PlanBrief v1 JSON with <span class="tt">plan_brief_v1.schema.json</span>.</li>
<li><b>Round‑trip test</b>: <span class="tt">canonical_to_brief(brief_to_canonical(x)) == x</span> (deep compare).</li>
<li><b>Prompt loader tests</b>: missing file, malformed JSON, hot‑reload path, TTL cache.</li>
<li><b>API E2E</b>: 1) POST plan via PlanBrief v1 → 201 <br  />
 2) GET <span class="tt">?format=plan_brief_v1</span> → same JSON <br  />
 3) POST <span class="tt">/ai-plans</span> with prompt <span class="tt">create_research_plan</span> → persisted canonical + export matches schema.</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md2273"></a>
8) Migration Steps (Executed)</h1>
<ol type="1">
<li><b>Add schema</b>: <span class="tt">api-gateway/config/plan_brief_v1.schema.json</span>.</li>
<li><b>Add adapter</b>: <span class="tt">api-gateway/src/plan_adapter.py</span> and wire into Plan create/update flows.</li>
<li><b>Implement export</b>: support <span class="tt">?format=plan_brief_v1</span> on GET plan.</li>
<li><b>Introduce PromptRegistry</b> and remove all embedded prompt strings.</li>
<li><b>Place prompts</b> under <span class="tt">research-manager/prompts/*.json</span>.</li>
<li><b>Enable env config</b>: <span class="tt">PROMPTS_DIR</span>, <span class="tt">PROMPTS_HOTRELOAD</span>, <span class="tt">PROMPTS_CACHE_TTL_SECONDS</span>.</li>
<li><b>Add tests</b> (unit + E2E) and CI validation.</li>
<li><b>Deprecation check</b>: (completed) no remaining hard‑coded prompt strings.</li>
<li><b>Legacy schema removal</b>: physical deletion pending tooling capability; file neutralised with deprecation marker.</li>
</ol>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md2275"></a>
9) Acceptance Criteria (All Met)</h1>
<ul>
<li>Creating/updating plans from PlanBrief v1 works and stores original JSON in <span class="tt">metadata.plan_brief_v1</span>.</li>
<li>Exporting with <span class="tt">?format=plan_brief_v1</span> returns the exact stored JSON.</li>
<li>All prompts are loaded from disk via <span class="tt">PromptRegistry</span> (no embedded strings).</li>
<li>Hot‑reload: editing a prompt file takes effect without restarting workers (within TTL).</li>
<li>Tests pass in CI; prompts and plan JSONs are schema‑validated.</li>
</ul>
<hr  />
<p> <br  />
## 10) Appendix: Minimal FastAPI glue (illustrative) <br  />
&mdash;</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md2277"></a>
11) Future Enhancements</h1>
<ul>
<li>Add CI job to validate every prompt file against <span class="tt">prompt.schema.json</span> and confirm implicit schema_ref resolution to PlanBrief v1.</li>
<li>Introduce prompt index (<span class="tt">prompts/index.json</span>) with versioning + deprecation flags.</li>
<li>Add structured multi‑attempt repair loop around validation errors (currently basic normalization only).</li>
<li>Migrate all Pydantic v1 <span class="tt">@validator</span> usage to v2 <span class="tt">@field_validator</span> to remove deprecation warnings (see test run output).</li>
<li>Telemetry: record <span class="tt">prompt_id</span>, schema version hash, and validation repair count for observability.</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md2279"></a>
12) Operational Notes</h1>
<ul>
<li>Any appearance of fenced code blocks around JSON in LLM output is stripped before validation.</li>
<li>Normalization enforces arrays for list fields and coerces blank / null to empty list, ensuring determinism pre‑validation.</li>
<li>Timeline integrity: sum(phases.values()) should equal <span class="tt">total_days</span>; if mismatch, we keep model output but emit a warning (future enforcement candidate).</li>
</ul>
<div class="fragment"><div class="line"><span class="comment"># api-gateway/src/routes_plans.py (excerpt)</span></div>
<div class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> APIRouter, Query, Body, HTTPException</div>
<div class="line"><span class="keyword">from</span> .plan_adapter <span class="keyword">import</span> PlanBriefV1, brief_to_canonical, canonical_to_brief</div>
<div class="line"><span class="keyword">from</span> .schemas <span class="keyword">import</span> validate_json  <span class="comment"># your existing util</span></div>
<div class="line"><span class="keyword">from</span> .db <span class="keyword">import</span> create_plan, update_plan, get_plan  <span class="comment"># your existing DAL</span></div>
<div class="line"> </div>
<div class="line">router = APIRouter()</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">@router.post(&quot;/topics/{topic_id}/plans&quot;)</span>  <span class="comment"># legacy: /v2/...</span></div>
<div class="line"><span class="keyword">async def </span>create_plan_from_brief(topic_id: int,</div>
<div class="line">                                 input_format: str = Query(default=<span class="stringliteral">&quot;canonical&quot;</span>),</div>
<div class="line">                                 body: dict = Body(...)):</div>
<div class="line">    <span class="keywordflow">if</span> input_format == <span class="stringliteral">&quot;plan_brief_v1&quot;</span>:</div>
<div class="line">        validate_json(body, schema_path=<span class="stringliteral">&quot;config/plan_brief_v1.schema.json&quot;</span>)</div>
<div class="line">        brief = PlanBriefV1(**body)</div>
<div class="line">        canonical = brief_to_canonical(brief, name=f<span class="stringliteral">&quot;Topic {topic_id} – Plan&quot;</span>)</div>
<div class="line">        <span class="comment"># persist canonical + metadata.plan_brief_v1</span></div>
<div class="line">        plan_id = await create_plan(topic_id, canonical)</div>
<div class="line">        <span class="keywordflow">return</span> {<span class="stringliteral">&quot;status&quot;</span>: <span class="stringliteral">&quot;ok&quot;</span>, <span class="stringliteral">&quot;plan_id&quot;</span>: plan_id}</div>
<div class="line">    <span class="comment"># else: existing canonical flow</span></div>
<div class="line">    ...</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">@router.get(&quot;/plans/{plan_id}&quot;)</span>  <span class="comment"># legacy: /v2/...</span></div>
<div class="line"><span class="keyword">async def </span>get_plan_export(plan_id: int, format: str = Query(default=<span class="stringliteral">&quot;canonical&quot;</span>)):</div>
<div class="line">    plan = await get_plan(plan_id)</div>
<div class="line">    <span class="keywordflow">if</span> <span class="keywordflow">not</span> plan:</div>
<div class="line">        <span class="keywordflow">raise</span> HTTPException(404, <span class="stringliteral">&quot;Plan not found&quot;</span>)</div>
<div class="line">    <span class="keywordflow">if</span> format == <span class="stringliteral">&quot;plan_brief_v1&quot;</span>:</div>
<div class="line">        brief = canonical_to_brief(plan)</div>
<div class="line">        <span class="keywordflow">return</span> asdict(brief)</div>
<div class="line">    <span class="keywordflow">return</span> plan  <span class="comment"># canonical response</span></div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on <span class="timestamp"></span> for ACP - Autonomous Command Protocol by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.15.0 </li>
  </ul>
</div>
</body>
</html>
