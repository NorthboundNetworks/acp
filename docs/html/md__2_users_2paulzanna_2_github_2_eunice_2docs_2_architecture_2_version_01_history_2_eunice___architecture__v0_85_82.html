<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.15.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ACP - Autonomous Command Protocol: Eunice v0.5.2 — Literature Review Integration (Planned Spec)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ACP - Autonomous Command Protocol<span id="projectnumber">&#160;v0.3.0</span>
   </div>
   <div id="projectbrief">Portable C99 framing library with COBS, CRC16, and HMAC-SHA256 authentication</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.15.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('md__2_users_2paulzanna_2_github_2_eunice_2docs_2_architecture_2_version_01_history_2_eunice___architecture__v0_85_82.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Eunice v0.5.2 — Literature Review Integration (Planned Spec) </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md1185"></a></p>
<p><b>Status:</b> Draft Specification • <b>Date:</b> 2025-08-11 • <b>Scope:</b> End‑to‑end literature review capability (search → dedup → screening → extraction → synthesis) integrated with existing research hierarchy.</p>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md1187"></a>
1) Goals</h1>
<ul>
<li>Provide systematic multi-source literature discovery linked to <span class="tt">research_topics</span> &amp; <span class="tt">research_plans</span>.</li>
<li>Enforce PRISMA-style screening pipeline with auditability &amp; metrics.</li>
<li>Enable structured evidence extraction (JSON) feeding research plans &amp; tasks.</li>
<li>Maintain idempotent search ingestion and deterministic deduplication.</li>
<li>Prepare foundation for future citation graph &amp; advanced analytics (deferred).</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md1188"></a>
2) Non-Goals (Deferred)</h1>
<ul>
<li>Full-text PDF download &amp; parsing</li>
<li>Citation network graph traversal/visualization</li>
<li>Multi-reviewer conflict resolution workflows (initial: single reviewer or AI assist)</li>
<li>Advanced NLP fact verification</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md1189"></a>
3) High-Level Flow</h1>
<div class="fragment"><div class="line">search_run -&gt; raw_results -&gt; normalize -&gt; deduplicate -&gt; records</div>
<div class="line">  -&gt; screening_queue(stage=title_abstract) -&gt; decisions</div>
<div class="line">    -&gt; stage=full_text -&gt; extraction -&gt; evidence summaries</div>
<div class="line">      -&gt; synthesis -&gt; attach to plan/tasks -&gt; prisma metrics</div>
</div><!-- fragment --><h1 class="doxsection"><a class="anchor" id="autotoc_md1190"></a>
4) Database Additions (Proposed)</h1>
<div class="fragment"><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> literature_search_runs (</div>
<div class="line">  id UUID <span class="keyword">PRIMARY</span> KEY <span class="keyword">DEFAULT</span> gen_random_uuid(),</div>
<div class="line">  topic_id UUID <span class="keyword">NOT</span> <span class="stringliteral">NULL</span> <span class="keyword">REFERENCES</span> research_topics(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE,</div>
<div class="line">  query TEXT <span class="keyword">NOT</span> <span class="stringliteral">NULL</span>,</div>
<div class="line">  sources TEXT[] <span class="keyword">NOT</span> <span class="stringliteral">NULL</span>,</div>
<div class="line">  normalized_params JSONB <span class="keyword">NOT</span> <span class="stringliteral">NULL</span> <span class="keyword">DEFAULT</span> <span class="stringliteral">&#39;{}&#39;</span>::jsonb,</div>
<div class="line">  status TEXT <span class="keyword">NOT</span> <span class="stringliteral">NULL</span> <span class="keyword">DEFAULT</span> <span class="stringliteral">&#39;completed&#39;</span>, <span class="comment">-- future: running|failed</span></div>
<div class="line">  result_count <span class="keywordtype">INTEGER</span> <span class="keyword">NOT</span> <span class="stringliteral">NULL</span> <span class="keyword">DEFAULT</span> <span class="stringliteral">0</span>,</div>
<div class="line">  deduped_count <span class="keywordtype">INTEGER</span> <span class="keyword">NOT</span> <span class="stringliteral">NULL</span> <span class="keyword">DEFAULT</span> <span class="stringliteral">0</span>,</div>
<div class="line">  created_at TIMESTAMPTZ <span class="keyword">NOT</span> <span class="stringliteral">NULL</span> <span class="keyword">DEFAULT</span> now()</div>
<div class="line">);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> literature_records</div>
<div class="line">  <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> <span class="keywordflow">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> canonical_doi TEXT,</div>
<div class="line">  <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> <span class="keywordflow">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> identifiers JSONB <span class="keyword">DEFAULT</span> <span class="stringliteral">&#39;{}&#39;</span>::jsonb, <span class="comment">-- PMID, arXiv, etc.</span></div>
<div class="line">  <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> <span class="keywordflow">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> provenance JSONB <span class="keyword">DEFAULT</span> <span class="stringliteral">&#39;[]&#39;</span>::jsonb;  <span class="comment">-- [{source, run_id, external_id}]</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> literature_screening_queue (</div>
<div class="line">  id UUID <span class="keyword">PRIMARY</span> KEY <span class="keyword">DEFAULT</span> gen_random_uuid(),</div>
<div class="line">  record_id UUID <span class="keyword">NOT</span> <span class="stringliteral">NULL</span> <span class="keyword">REFERENCES</span> literature_records(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE,</div>
<div class="line">  run_id UUID <span class="keyword">NOT</span> <span class="stringliteral">NULL</span> <span class="keyword">REFERENCES</span> literature_search_runs(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE,</div>
<div class="line">  stage TEXT <span class="keyword">NOT</span> <span class="stringliteral">NULL</span>, <span class="comment">-- title_abstract | full_text</span></div>
<div class="line">  status TEXT <span class="keyword">NOT</span> <span class="stringliteral">NULL</span> <span class="keyword">DEFAULT</span> <span class="stringliteral">&#39;queued&#39;</span>, <span class="comment">-- queued|included|excluded|conflict</span></div>
<div class="line">  reviewer TEXT, <span class="comment">-- user id or &#39;ai&#39;</span></div>
<div class="line">  rationale TEXT,</div>
<div class="line">  decided_at TIMESTAMPTZ,</div>
<div class="line">  created_at TIMESTAMPTZ <span class="keyword">NOT</span> <span class="stringliteral">NULL</span> <span class="keyword">DEFAULT</span> now()</div>
<div class="line">);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">CREATE</span> INDEX <span class="keyword">ON</span> literature_screening_queue (stage, status);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> literature_extractions (</div>
<div class="line">  id UUID <span class="keyword">PRIMARY</span> KEY <span class="keyword">DEFAULT</span> gen_random_uuid(),</div>
<div class="line">  record_id UUID <span class="keyword">NOT</span> <span class="stringliteral">NULL</span> <span class="keyword">REFERENCES</span> literature_records(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE,</div>
<div class="line">  extraction_schema_version TEXT <span class="keyword">NOT</span> <span class="stringliteral">NULL</span> <span class="keyword">DEFAULT</span> <span class="stringliteral">&#39;v1&#39;</span>,</div>
<div class="line">  content JSONB <span class="keyword">NOT</span> <span class="stringliteral">NULL</span>,</div>
<div class="line">  confidence <span class="keywordtype">NUMERIC</span>(<span class="stringliteral">5</span>,<span class="stringliteral">2</span>),</div>
<div class="line">  created_at TIMESTAMPTZ <span class="keyword">NOT</span> <span class="stringliteral">NULL</span> <span class="keyword">DEFAULT</span> now()</div>
<div class="line">);</div>
<div class="line"> </div>
<div class="line"><span class="comment">-- Optional materialized view for PRISMA metrics (auto-created at service startup if absent):</span></div>
<div class="line"><span class="comment">-- literature_prisma_view(topic_id, identified, deduped, screened, excluded, included)</span></div>
</div><!-- fragment --><h1 class="doxsection"><a class="anchor" id="autotoc_md1191"></a>
5) Tool &amp; API Surface (Initial)</h1>
<ul>
<li><span class="tt">literature_search</span> (Network) — performs multi-source queries, returns run summary.</li>
<li><span class="tt">literature_screen_next</span> (DB) — leases next queue item (FOR UPDATE SKIP LOCKED) with simple lease TTL.</li>
<li><span class="tt">literature_screen_update</span> (DB) — apply decision + rationale; if included at title_abstract → enqueue full_text stage.</li>
<li><span class="tt">literature_extract</span> (Network+DB) — fetch metadata + abstract, run extraction LLM, validate JSON schema, store extraction.</li>
<li><span class="tt">literature_prisma_summary</span> (DB) — aggregate counts for given topic/run.</li>
<li><span class="tt">literature_screen_queue_stats</span> (DB) — snapshot queue metrics (queued, leased, expired, avg_age_seconds) per stage + refresh gauges.</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md1192"></a>
5a) Retrieval &amp; Ranking (Deterministic)</h1>
<p>For each record <em>r</em> from the deduplicated set, compute:</p>
<ul>
<li><b>RRF (reciprocal rank fusion)</b> across sources: <br  />
 ( r.rrf = \sum_{s} \frac{1}{k + \mathrm{rank}_s(r)} ), with default ( k = 60 ) (configurable).</li>
<li><b>BM25</b> over <span class="tt">title + abstract</span> using the normalised query terms from the query builder.</li>
<li><b>Embedding cosine similarity</b> between an embedding of <span class="tt">title + abstract</span> and an embedding of the topic brief (or the query expansion text) generated by the query builder.</li>
</ul>
<p>Final score: <br  />
 ( r.search_score = w_1\cdot r.rrf + w_2\cdot r.bm25 + w_3\cdot r.cosine ) <br  />
 <b>Defaults:</b> <span class="tt">w1=0.5, w2=0.3, w3=0.2</span> (configurable).</p>
<p><b>Persist</b> <span class="tt">{rrf, bm25, cosine, search_score}</span> on <span class="tt">literature_records</span> for explainability and later learning-to-rank. <br  />
 <b>Ties:</b> prefer newer publication year, then source priority (<span class="tt">pubmed &gt; openalex &gt; arxiv</span>), then lexical order of canonical DOI. <br  />
 <b>Determinism:</b> RRF uses source-native integer ranks captured at fetch time; BM25 and embeddings must use fixed tokenisation/normalisation and a pinned embedding model version.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md1193"></a>
5b) <span class="tt">literature_search</span> Tool I/O (Schema)</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md1194"></a>
Input</h2>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;sources&quot;: [&quot;pubmed&quot;, &quot;openalex&quot;, &quot;arxiv&quot;],</div>
<div class="line">  &quot;normalized_params&quot;: {</div>
<div class="line">    &quot;boolean_queries&quot;: [&quot;(avian OR chicken) AND neuron* AND culture*&quot;],</div>
<div class="line">    &quot;mesh&quot;: [&quot;Neurons&quot;, &quot;Cell Culture Techniques&quot;],</div>
<div class="line">    &quot;date_range&quot;: {&quot;from&quot;: &quot;2019-01-01&quot;, &quot;to&quot;: null},</div>
<div class="line">    &quot;filters&quot;: {&quot;language&quot;: [&quot;en&quot;], &quot;type&quot;: [&quot;journal-article&quot;, &quot;preprint&quot;]},</div>
<div class="line">    &quot;limit&quot;: 500,</div>
<div class="line">    &quot;cursor&quot;: null</div>
<div class="line">  },</div>
<div class="line">  &quot;idempotency_key&quot;: &quot;sha256(sources|normalized_params)&quot;</div>
<div class="line">}</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md1195"></a>
Output</h2>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;run_id&quot;: &quot;uuid&quot;,</div>
<div class="line">  &quot;result_count&quot;: 1234,</div>
<div class="line">  &quot;deduped_count&quot;: 412,</div>
<div class="line">  &quot;cursor&quot;: null,</div>
<div class="line">  &quot;sources&quot;: [{&quot;name&quot;: &quot;pubmed&quot;, &quot;fetched&quot;: 800}, {&quot;name&quot;:&quot;openalex&quot;,&quot;fetched&quot;:300}, {&quot;name&quot;:&quot;arxiv&quot;,&quot;fetched&quot;:134}]</div>
<div class="line">}</div>
</div><!-- fragment --><h1 class="doxsection"><a class="anchor" id="autotoc_md1196"></a>
6) Deduplication Strategy</h1>
<p>Priority order for canonical identity (implemented):</p>
<ol type="1">
<li>DOI (case-insensitive exact match)</li>
<li>arXiv ID</li>
<li>PMID</li>
<li>Title-Year fuzzy (difflib.SequenceMatcher ratio ≥ 0.9, same year)</li>
</ol>
<p>On encounter (implemented semantics):</p>
<ul>
<li>Compute a canonical key in precedence order (first non-null among DOI, arXiv, PMID). If none, attempt Title+Year fuzzy match against an in-memory index of prior titles (normalized lowercase, stripped punctuation) using <span class="tt">SequenceMatcher.ratio()</span>.</li>
<li>If a match/canonical exists, perform an in-memory merge before persistence: union provenance entries (deduplicated by <span class="tt">(source, external_id, doi, source_rank)</span>), increment duplicate counter, and preserve authors union + max citation_count.</li>
<li>Maintain mutable <span class="tt">identifiers</span> JSONB (keys: doi, pmid, arxiv). When a new higher-precedence identifier (e.g., DOI) appears for an existing record previously keyed by a lower-precedence id (e.g., arXiv), promote it by setting <span class="tt">canonical_doi</span> and persisting an update.</li>
<li>Fallback database merge lookups now cascade: <span class="tt">canonical_doi</span> → <span class="tt">identifiers-&gt;&gt;'arxiv'</span> → <span class="tt">identifiers-&gt;&gt;'pmid'</span>. (Implemented by extending <span class="tt">db.query</span> to allow vetted jsonb subfield equality filters.)</li>
<li>Title-Year fuzzy merge remains in-memory only (no cross-run DB fuzzy search yet) to keep latency deterministic.</li>
<li>Do not enqueue an additional screening queue item for merged duplicates (single screening lifecycle per canonical record).</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md1197"></a>
6a) Deduplication Details</h1>
<p><b>Identity precedence (implemented):</b> <span class="tt">DOI &gt; arXiv &gt; PMID &gt; Title+Year</span> (fuzzy via <span class="tt">SequenceMatcher.ratio() ≥ 0.9</span>, same year). <br  />
 On merge: union provenance (stable ordering by earliest source rank then source name), keep earliest <span class="tt">ingested_at</span>, prefer DOI-sourced (or journal) metadata for canonical bibliographic fields (title, journal, year when conflicts). <br  />
 Partial indexes (planned): <span class="tt">(lower(canonical_doi))</span>, <span class="tt">(identifiers-&gt;&gt;'arxiv')</span> WHERE not null, plus future <span class="tt">(identifiers-&gt;&gt;'pmid')</span>. <br  />
 <b>Preprint ↔ Journal</b> (planned enhancement): detect author overlap ≥ 60% (set similarity) to consolidate; current implementation relies solely on DOI or fuzzy title-year without author overlap heuristic. <br  />
 Duplicate counting: stored in record metadata (<span class="tt">metadata-&gt;duplicate_count</span>) incremented during ingestion loop (implemented in-memory; persisted per update cycle).</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md1198"></a>
6b) Merge / Upsert Implementation Status (Updated)</h2>
<p>Implemented:</p>
<ul>
<li>Lookup order for existing record: <span class="tt">canonical_doi</span> first, then <span class="tt">identifiers-&gt;&gt;'arxiv'</span>, then <span class="tt">identifiers-&gt;&gt;'pmid'</span> using extended <span class="tt">db.query</span> jsonb subfield filters.</li>
<li>In-memory provenance aggregation prior to persistence; provenance array deduplicated by <span class="tt">(source, external_id, doi, source_rank)</span> ensuring idempotency across runs.</li>
<li><span class="tt">citation_count</span> preserved as the maximum observed value during updates (never decreased).</li>
<li><span class="tt">duplicate_count</span> tracked in-memory and stored under <span class="tt">metadata.duplicate_count</span> at create time (future: persist updates on merge to reflect cumulative duplicates across runs).</li>
<li>Identifiers map merged (existing values retained; new keys added; DOI promoted to <span class="tt">canonical_doi</span> when first seen).</li>
<li>Create vs update metrics captured at DB layer via <span class="tt">literature_record_merge_total{action=create|update}</span> and surfaced in network response as <span class="tt">create_count</span> and <span class="tt">merge_count</span>.</li>
</ul>
<p>Pending / Future Enhancements:</p>
<ul>
<li>Cross-run fuzzy Title-Year consolidation at DB layer (PARTIAL: year-filtered candidate query + in-process fuzzy + optional author overlap; full trigram index + weighted ranking deferred).</li>
<li>Author overlap heuristic (PARTIAL: applied when preprint vs journal detected with &gt;=60% overlap; needs refinement for author disambiguation and multi-affiliation noise).</li>
<li>Optional historical score retention variants (currently max retention implemented; future variant may track time-series or decay-weighted scores).</li>
<li>Additional metadata enrichment (e.g., first_ingested_at vs updated_at) and provenance ordering guarantees.</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md1199"></a>
7) Screening Workflow</h1>
<p>Stages:</p>
<ol type="1">
<li>title_abstract — quick triage</li>
<li>full_text — deeper review (subset only)</li>
</ol>
<p>Status transitions:</p>
<ul>
<li>queued → included|excluded</li>
<li>included (title_abstract) → queued (full_text)</li>
<li>included (full_text) = final inclusion</li>
</ul>
<p>Decision Record:</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;decision&quot;: &quot;included&quot;,</div>
<div class="line">  &quot;stage&quot;: &quot;title_abstract&quot;,</div>
<div class="line">  &quot;rationale&quot;: &quot;Relevance to objective: addresses methodology&quot;</div>
<div class="line">}</div>
</div><!-- fragment --><h1 class="doxsection"><a class="anchor" id="autotoc_md1200"></a>
7a) Screening Queue Semantics</h1>
<ul>
<li>Queue acquisition uses <span class="tt">FOR UPDATE SKIP LOCKED</span> with a lease <b>TTL=90s</b> and a <b>heartbeat</b> every 30s. <br  />
</li>
<li>Expiry: rows with <span class="tt">status='queued' AND leased_at &lt; now()-TTL</span> are recyclable. <br  />
</li>
<li>Decision uniqueness: one decision per <span class="tt">(record_id, stage)</span>; later updates overwrite within stage. <br  />
</li>
<li>Metrics: enqueues, leases (ok|empty|error), decisions (included|excluded), expiries, plus gauges for queue depth, leased count, and average age (age via <span class="tt">literature_screen_queue_stats</span>).</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md1201"></a>
8) Extraction Schema (v1 draft)</h1>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;type&quot;: &quot;object&quot;,</div>
<div class="line">  &quot;required&quot;: [&quot;population&quot;,&quot;methods&quot;,&quot;key_findings&quot;],</div>
<div class="line">  &quot;properties&quot;: {</div>
<div class="line">    &quot;population&quot;: {&quot;type&quot;:&quot;string&quot;},</div>
<div class="line">    &quot;interventions&quot;: {&quot;type&quot;:&quot;array&quot;,&quot;items&quot;:{&quot;type&quot;:&quot;string&quot;}},</div>
<div class="line">    &quot;comparators&quot;: {&quot;type&quot;:&quot;array&quot;,&quot;items&quot;:{&quot;type&quot;:&quot;string&quot;}},</div>
<div class="line">    &quot;outcomes&quot;: {&quot;type&quot;:&quot;array&quot;,&quot;items&quot;:{&quot;type&quot;:&quot;string&quot;}},</div>
<div class="line">    &quot;methods&quot;: {&quot;type&quot;:&quot;string&quot;},</div>
<div class="line">    &quot;sample_size&quot;: {&quot;type&quot;:&quot;integer&quot;},</div>
<div class="line">    &quot;key_findings&quot;: {&quot;type&quot;:&quot;array&quot;,&quot;items&quot;:{&quot;type&quot;:&quot;string&quot;}},</div>
<div class="line">    &quot;limitations&quot;: {&quot;type&quot;:&quot;array&quot;,&quot;items&quot;:{&quot;type&quot;:&quot;string&quot;}}</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p>Repair attempt (implemented): single retry pathway invoked server-side when JSON Schema validation fails. Current automated repair transformations:</p>
<ul>
<li>Trim &amp; normalize whitespace in string fields.</li>
<li>Remove empty strings from arrays; deduplicate list items while preserving order.</li>
<li>Flatten single-item nested lists (e.g., <span class="tt">[ ["value"] ] -&gt; ["value"]</span>).</li>
<li>Drop fields set to empty arrays after cleanup (except required arrays which must contain ≥1 item post-repair).</li>
<li>(Implemented) Coerce numeric-like strings for <span class="tt">sample_size</span> to integer during repair.</li>
</ul>
<p>If repaired payload validates, it is stored with a <span class="tt">repair_applied=true</span> metadata flag (planned flag; current implementation simply logs success). On second failure the error is surfaced; no further retries.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md1202"></a>
9) Idempotency Rules</h1>
<ul>
<li>Search run: hash of <span class="tt">(sorted_sources, normalized_query, params)</span> used as optional <span class="tt">idempotency_key</span>.</li>
<li>Extraction: stable key <span class="tt">record_id:extraction_schema_version:v1</span> prevents duplicates.</li>
<li>Screening decisions: uniqueness on <span class="tt">(record_id, stage)</span>; updates overwrite prior within stage.</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md1203"></a>
10) Metrics</h1>
<p>Implemented Metrics (complete v0.5.2 scope):</p>
<ul>
<li><span class="tt">lit_search_runs_total{source}</span> — external source fetch counts per search run.</li>
<li><span class="tt">literature_record_merge_total{action}</span> — create vs update events (DB layer).</li>
<li><span class="tt">lit_records_total</span> &amp; <span class="tt">lit_records_deduped_total</span> — total unique literature records (mirrored gauges).</li>
<li><span class="tt">lit_screen_decision_total{stage,decision}</span> — screening decisions (included|excluded).</li>
<li><span class="tt">lit_screen_enqueue_total{stage}</span> — enqueues per stage.</li>
<li><span class="tt">lit_screen_lease_total{stage,status}</span> — lease outcomes (ok|empty|error).</li>
<li><span class="tt">lit_screen_expired_total</span> — recycled expired leases.</li>
<li><span class="tt">lit_screen_queue_depth{stage}</span> — queued items gauge.</li>
<li><span class="tt">lit_screen_queue_leased{stage}</span> — leased items gauge.</li>
<li><span class="tt">lit_screen_queue_avg_age_seconds{stage}</span> — average queued item age in seconds.</li>
<li><span class="tt">lit_screen_queue_expired{stage}</span> — currently expired queued items.</li>
<li><span class="tt">literature_extraction_total{status}</span> — extraction attempt outcomes (ok|error).</li>
<li><span class="tt">lit_extraction_failures_total{reason}</span> — categorized extraction failures (missing_required|wrong_type|serialization|unknown_schema|exception|other).</li>
<li><span class="tt">lit_prisma_count{topic_id,phase}</span> — PRISMA phase counts (identified|deduped|screened|excluded|included) via materialized view or fallback.</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md1204"></a>
10a) Metrics &amp; PRISMA Verification</h1>
<ul>
<li>Core counters/gauges now emitted (v0.5.2 complete): <span class="tt">lit_search_runs_total</span>, <span class="tt">literature_record_merge_total</span>, <span class="tt">lit_records_total</span>, <span class="tt">lit_records_deduped_total</span>, <span class="tt">lit_screen_decision_total</span>, <span class="tt">lit_screen_enqueue_total</span>, <span class="tt">lit_screen_lease_total</span>, <span class="tt">lit_screen_expired_total</span>, <span class="tt">lit_screen_queue_depth</span>, <span class="tt">lit_screen_queue_leased</span>, <span class="tt">lit_screen_queue_avg_age_seconds</span>, <span class="tt">lit_screen_queue_expired</span>, <span class="tt">literature_extraction_total</span>, <span class="tt">lit_extraction_failures_total</span>, <span class="tt">lit_prisma_count</span>.</li>
</ul>
<p><b>Validation:</b> PRISMA view counts must match base tables within a single transaction snapshot. Provide a daily integrity check that compares the view against source tables and emits a warning on mismatch &gt; 1%. Planned addition: verify that <span class="tt">literature_record_merge_total{action}</span> deltas reconcile with net new rows + updates for audit.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md1205"></a>
11) Logs (Structured Fields)</h1>
<p><span class="tt">{ trace_id, run_id, record_id, stage, decision, dedup:bool, extraction_ms, merge_action, lookup_order }</span></p>
<p>Added fields (planned usage) list:</p>
<ul>
<li><span class="tt">merge_action</span> = create|update during ingestion</li>
<li><span class="tt">lookup_order</span> records which identifier type matched (doi|arxiv|pmid|fuzzy) for transparency</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md1206"></a>
12) Security &amp; Compliance</h1>
<ul>
<li>Rate limiting per external source.</li>
<li>Sanitization of abstract text (no PII persistence beyond citation metadata).</li>
<li>Optional allowlist for sources.</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md1207"></a>
13) Rollout Plan</h1>
<ol type="1">
<li>Migrations: add tables &amp; columns (feature flag disabled).</li>
<li>Implement search ingestion &amp; dedup path (hidden API/tool behind flag).</li>
<li>Add screening queue endpoints/tools.</li>
<li>Add extraction &amp; schema validation.</li>
<li>Expose PRISMA summary.</li>
<li>Frontend minimal views (search form, queue, counters).</li>
<li>Enable feature flag &amp; gather performance metrics.</li>
</ol>
<h1 class="doxsection"><a class="anchor" id="autotoc_md1208"></a>
14) Risks &amp; Mitigations</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Risk  </th><th class="markdownTableHeadNone">Mitigation  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">API rate limits  </td><td class="markdownTableBodyNone">Backoff + staggered batching  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Duplicate suppression errors  </td><td class="markdownTableBodyNone">Logging + manual override flag on records  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Extraction hallucination.  </td><td class="markdownTableBodyNone">Strict schema + repair attempt + confidence score  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Queue starvation  </td><td class="markdownTableBodyNone">Heartbeat &amp; lease expiry recycling  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">---------------------------&mdash;  </td><td class="markdownTableBodyNone">------------------------------------------------&mdash;  </td></tr>
</table>
<h1 class="doxsection"><a class="anchor" id="autotoc_md1209"></a>
15) Success Criteria</h1>
<ul>
<li>≥95% duplicate suppression vs raw result count.</li>
<li>≤2% extraction validation failures after one repair.</li>
<li>PRISMA counts reconcile with table queries.</li>
<li>End-to-end flow operational under concurrent searches.</li>
</ul>
<hr  />
 <hr  />
<p> End of Draft Spec (v0.5.2) </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on <span class="timestamp"></span> for ACP - Autonomous Command Protocol by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.15.0 </li>
  </ul>
</div>
</body>
</html>
